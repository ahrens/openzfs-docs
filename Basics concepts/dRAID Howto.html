
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>dRAID Howto &#8212; OpenZFS  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="License" href="../License.html" />
    <link rel="prev" title="Troubleshooting" href="Troubleshooting.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="draid-howto">
<h1>dRAID Howto<a class="headerlink" href="#draid-howto" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This page a describes <em>work in progress</em> functionality, which is not yet
merged in master branch.</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="raidz-vs-draid">
<h3>raidz vs draid<a class="headerlink" href="#raidz-vs-draid" title="Permalink to this headline">¶</a></h3>
<p>ZFS users are most likely very familiar with raidz already, so a
comparison with draid would help. The illustrations below are
simplified, but sufficient for the purpose of a comparison. For example,
31 drives can be configured as a zpool of 6 raidz1 vdevs and a hot
spare: <img alt="raidz1" src="../_images/draid_raidz.png" /></p>
<p>As shown above, if drive 0 fails and is replaced by the hot spare, only
5 out of the 30 surviving drives will work to resilver: drives 1-4 read,
and drive 30 writes.</p>
<p>The same 30 drives can be configured as 1 draid1 vdev of the same level
of redundancy (i.e. single parity, 1/4 parity ratio) and single spare
capacity: <img alt="draid1" src="../_images/draid_draid.png" /></p>
<p>The drives are shuffled in a way that, after drive 0 fails, all 30
surviving drives will work together to restore the lost data/parity:</p>
<ul class="simple">
<li>All 30 drives read, because unlike the raidz1 configuration shown
above, in the draid1 configuration the neighbor drives of the failed
drive 0 (i.e. drives in a same data+parity group) are not fixed.</li>
<li>All 30 drives write, because now there is no dedicated spare drive.
Instead, spare blocks come from all drives.</li>
</ul>
<p>To summarize:</p>
<ul class="simple">
<li>Normal application IO: draid and raidz are very similar. There’s a
slight advantage in draid, since there’s no dedicated spare drive
which is idle when not in use.</li>
<li>Restore lost data/parity: for raidz, not all surviving drives will
work to rebuild, and in addition it’s bounded by the write throughput
of a single replacement drive. For draid, the rebuild speed will
scale with the total number of drives because all surviving drives
will work to rebuild.</li>
</ul>
<p>The dRAID vdev must shuffle its child drives in a way that regardless of
which drive has failed, the rebuild IO (both read and write) will
distribute evenly among all surviving drives, so the rebuild speed will
scale. The exact mechanism used by the dRAID vdev driver is beyond the
scope of this simple introduction here. If interested, please refer to
the recommended readings in the next section.</p>
</div>
<div class="section" id="recommended-reading">
<h3>Recommended Reading<a class="headerlink" href="#recommended-reading" title="Permalink to this headline">¶</a></h3>
<p>Parity declustering (the fancy term for shuffling drives) has been an
active research topic, and many papers have been published in this area.
The <a class="reference external" href="http://www.cse.scu.edu/~tschwarz/TechReports/hpca.pdf">Permutation Development Data
Layout</a> is a
good paper to begin. The dRAID vdev driver uses a shuffling algorithm
loosely based on the mechanism described in this paper.</p>
</div>
</div>
<div class="section" id="using-draid">
<h2>Using dRAID<a class="headerlink" href="#using-draid" title="Permalink to this headline">¶</a></h2>
<p>First get the code <a class="reference external" href="https://github.com/openzfs/zfs/pull/10102">here</a>,
build zfs with <em>configure –enable-debug</em>, and install. Then load the
zfs kernel module with the following options which help dRAID rebuild
performance.</p>
<ul class="simple">
<li>zfs_vdev_scrub_max_active=10</li>
<li>zfs_vdev_async_write_min_active=4</li>
</ul>
<div class="section" id="create-a-draid-vdev">
<h3>Create a dRAID vdev<a class="headerlink" href="#create-a-draid-vdev" title="Permalink to this headline">¶</a></h3>
<p>Similar to raidz vdev a dRAID vdev can be created using the
<code class="docutils literal notranslate"><span class="pre">zpool</span> <span class="pre">create</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zpool create &lt;pool&gt; draid[1,2,3][ &lt;vdevs...&gt;</span>
</pre></div>
</div>
<p>Unlike raidz, additional options may be provided as part of the
<code class="docutils literal notranslate"><span class="pre">draid</span></code> vdev type to specify an exact dRAID layout. When unspecific
reasonable defaults will be chosen.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zpool create &lt;pool&gt; draid[1,2,3][:&lt;groups&gt;g][:&lt;spares&gt;s][:&lt;data&gt;d][:&lt;iterations&gt;] &lt;vdevs...&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li>groups - Number of redundancy groups (default: 1 group per 12 vdevs)</li>
<li>spares - Number of distributed hot spares (default: 1)</li>
<li>data - Number of data devices per group (default: determined by
number of groups)</li>
<li>iterations - Number of iterations to perform generating a valid dRAID
mapping (default 3).</li>
</ul>
<p><em>Notes</em>:</p>
<ul class="simple">
<li>The default values are not set in stone and may change.</li>
<li>For the majority of common configurations we intend to provide
pre-computed balanced dRAID mappings.</li>
<li>When <em>data</em> is specified then: (draid_children - spares) % (parity +
data) == 0, otherwise the pool creation will fail.</li>
</ul>
<p>Now the dRAID vdev is online and ready for IO:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">pool</span><span class="p">:</span> <span class="n">tank</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">ONLINE</span>
<span class="n">config</span><span class="p">:</span>

    <span class="n">NAME</span>                 <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
    <span class="n">tank</span>                 <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
      <span class="n">draid2</span><span class="p">:</span><span class="mi">4</span><span class="n">g</span><span class="p">:</span><span class="mi">2</span><span class="n">s</span><span class="o">-</span><span class="mi">0</span>     <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">L0</span>               <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">L1</span>               <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">L2</span>               <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">L3</span>               <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="o">...</span>
        <span class="n">L50</span>              <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">L51</span>              <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">L52</span>              <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
    <span class="n">spares</span>
      <span class="n">s0</span><span class="o">-</span><span class="n">draid2</span><span class="p">:</span><span class="mi">4</span><span class="n">g</span><span class="p">:</span><span class="mi">2</span><span class="n">s</span><span class="o">-</span><span class="mi">0</span>  <span class="n">AVAIL</span>
      <span class="n">s1</span><span class="o">-</span><span class="n">draid2</span><span class="p">:</span><span class="mi">4</span><span class="n">g</span><span class="p">:</span><span class="mi">2</span><span class="n">s</span><span class="o">-</span><span class="mi">0</span>  <span class="n">AVAIL</span>

<span class="n">errors</span><span class="p">:</span> <span class="n">No</span> <span class="n">known</span> <span class="n">data</span> <span class="n">errors</span>
</pre></div>
</div>
<p>There are two logical hot spare vdevs shown above at the bottom:</p>
<ul class="simple">
<li>The names begin with a <code class="docutils literal notranslate"><span class="pre">s&lt;id&gt;-</span></code> followed by the name of the parent
dRAID vdev.</li>
<li>These hot spares are logical, made from reserved blocks on all the 53
child drives of the dRAID vdev.</li>
<li>Unlike traditional hot spares, the distributed spare can only replace
a drive in its parent dRAID vdev.</li>
</ul>
<p>The dRAID vdev behaves just like a raidz vdev of the same parity level.
You can do IO to/from it, scrub it, fail a child drive and it’d operate
in degraded mode.</p>
</div>
<div class="section" id="rebuild-to-distributed-spare">
<h3>Rebuild to distributed spare<a class="headerlink" href="#rebuild-to-distributed-spare" title="Permalink to this headline">¶</a></h3>
<p>When there’s a failed/offline child drive, the dRAID vdev supports a
completely new mechanism to reconstruct lost data/parity, in addition to
the resilver. First of all, resilver is still supported - if a failed
drive is replaced by another physical drive, the resilver process is
used to reconstruct lost data/parity to the new replacement drive, which
is the same as a resilver in a raidz vdev.</p>
<p>But if a child drive is replaced with a distributed spare, a new process
called rebuild is used instead of resilver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zpool offline tank sdo</span>
<span class="c1"># zpool replace tank sdo &#39;%draid1-0-s0&#39;</span>
<span class="c1"># zpool status</span>
  <span class="n">pool</span><span class="p">:</span> <span class="n">tank</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">DEGRADED</span>
<span class="n">status</span><span class="p">:</span> <span class="n">One</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">devices</span> <span class="n">has</span> <span class="n">been</span> <span class="n">taken</span> <span class="n">offline</span> <span class="n">by</span> <span class="n">the</span> <span class="n">administrator</span><span class="o">.</span>
        <span class="n">Sufficient</span> <span class="n">replicas</span> <span class="n">exist</span> <span class="k">for</span> <span class="n">the</span> <span class="n">pool</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">functioning</span> <span class="ow">in</span> <span class="n">a</span>
        <span class="n">degraded</span> <span class="n">state</span><span class="o">.</span>
<span class="n">action</span><span class="p">:</span> <span class="n">Online</span> <span class="n">the</span> <span class="n">device</span> <span class="n">using</span> <span class="s1">&#39;zpool online&#39;</span> <span class="ow">or</span> <span class="n">replace</span> <span class="n">the</span> <span class="n">device</span> <span class="k">with</span>
        <span class="s1">&#39;zpool replace&#39;</span><span class="o">.</span>
  <span class="n">scan</span><span class="p">:</span> <span class="n">rebuilt</span> <span class="mf">2.00</span><span class="n">G</span> <span class="ow">in</span> <span class="mi">0</span><span class="n">h0m5s</span> <span class="k">with</span> <span class="mi">0</span> <span class="n">errors</span> <span class="n">on</span> <span class="n">Fri</span> <span class="n">Feb</span> <span class="mi">24</span> <span class="mi">20</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">06</span> <span class="mi">2017</span>
<span class="n">config</span><span class="p">:</span>

        <span class="n">NAME</span>                <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
        <span class="n">tank</span>                <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
          <span class="n">draid1</span><span class="o">-</span><span class="mi">0</span>          <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdd</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sde</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdf</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdg</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdh</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdu</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdj</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdv</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdl</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdm</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdn</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">spare</span><span class="o">-</span><span class="mi">11</span>        <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="n">sdo</span>           <span class="n">OFFLINE</span>      <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s0</span>  <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdp</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdq</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdr</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sds</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdt</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">spares</span>
          <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s0</span>      <span class="n">INUSE</span>     <span class="n">currently</span> <span class="ow">in</span> <span class="n">use</span>
          <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s1</span>      <span class="n">AVAIL</span>
</pre></div>
</div>
<p>The scan status line of the <em>zpool status</em> output now says <em>“rebuilt”</em>
instead of <em>“resilvered”</em>, because the lost data/parity was rebuilt to
the distributed spare by a brand new process called <em>“rebuild”</em>. The
main differences from <em>resilver</em> are:</p>
<ul class="simple">
<li>The rebuild process does not scan the whole block pointer tree.
Instead, it only scans the spacemap objects.</li>
<li>The IO from rebuild is sequential, because it rebuilds metaslabs one
by one in sequential order.</li>
<li>The rebuild process is not limited to block boundaries. For example,
if 10 64K blocks are allocated contiguously, then rebuild will fix
640K at one time. So rebuild process will generate larger IOs than
resilver.</li>
<li>For all the benefits above, there is one price to pay. The rebuild
process cannot verify block checksums, since it doesn’t have block
pointers.</li>
<li>Moreover, the rebuild process requires support from on-disk format,
and <strong>only</strong> works on draid and mirror vdevs. Resilver, on the other
hand, works with any vdev (including draid).</li>
</ul>
<p>Although rebuild process creates larger IOs, the drives will not
necessarily see large IO requests. The block device queue parameter
<em>/sys/block/</em>/queue/max_sectors_kb* must be tuned accordingly. However,
since the rebuild IO is already sequential, the benefits of enabling
larger IO requests might be marginal.</p>
<p>At this point, redundancy has been fully restored without adding any new
drive to the pool. If another drive is offlined, the pool is still able
to do IO:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zpool offline tank sdj</span>
<span class="c1"># zpool status</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">DEGRADED</span>
<span class="n">status</span><span class="p">:</span> <span class="n">One</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">devices</span> <span class="n">has</span> <span class="n">been</span> <span class="n">taken</span> <span class="n">offline</span> <span class="n">by</span> <span class="n">the</span> <span class="n">administrator</span><span class="o">.</span>
        <span class="n">Sufficient</span> <span class="n">replicas</span> <span class="n">exist</span> <span class="k">for</span> <span class="n">the</span> <span class="n">pool</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">functioning</span> <span class="ow">in</span> <span class="n">a</span>
        <span class="n">degraded</span> <span class="n">state</span><span class="o">.</span>
<span class="n">action</span><span class="p">:</span> <span class="n">Online</span> <span class="n">the</span> <span class="n">device</span> <span class="n">using</span> <span class="s1">&#39;zpool online&#39;</span> <span class="ow">or</span> <span class="n">replace</span> <span class="n">the</span> <span class="n">device</span> <span class="k">with</span>
        <span class="s1">&#39;zpool replace&#39;</span><span class="o">.</span>
  <span class="n">scan</span><span class="p">:</span> <span class="n">rebuilt</span> <span class="mf">2.00</span><span class="n">G</span> <span class="ow">in</span> <span class="mi">0</span><span class="n">h0m5s</span> <span class="k">with</span> <span class="mi">0</span> <span class="n">errors</span> <span class="n">on</span> <span class="n">Fri</span> <span class="n">Feb</span> <span class="mi">24</span> <span class="mi">20</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">06</span> <span class="mi">2017</span>
<span class="n">config</span><span class="p">:</span>

        <span class="n">NAME</span>                <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
        <span class="n">tank</span>                <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
          <span class="n">draid1</span><span class="o">-</span><span class="mi">0</span>          <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdd</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sde</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdf</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdg</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdh</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdu</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdj</span>             <span class="n">OFFLINE</span>      <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdv</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdl</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdm</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdn</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">spare</span><span class="o">-</span><span class="mi">11</span>        <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="n">sdo</span>           <span class="n">OFFLINE</span>      <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s0</span>  <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdp</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdq</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdr</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sds</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdt</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">spares</span>
          <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s0</span>      <span class="n">INUSE</span>     <span class="n">currently</span> <span class="ow">in</span> <span class="n">use</span>
          <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s1</span>      <span class="n">AVAIL</span>
</pre></div>
</div>
<p>As shown above, the <em>draid1-0</em> vdev is still in <em>DEGRADED</em> mode although
two child drives have failed and it’s only single-parity. Since the
<em>%draid1-0-s1</em> is still <em>AVAIL</em>, full redundancy can be restored by
replacing <em>sdj</em> with it, without adding new drive to the pool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zpool replace tank sdj &#39;%draid1-0-s1&#39;</span>
<span class="c1"># zpool status</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">DEGRADED</span>
<span class="n">status</span><span class="p">:</span> <span class="n">One</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">devices</span> <span class="n">has</span> <span class="n">been</span> <span class="n">taken</span> <span class="n">offline</span> <span class="n">by</span> <span class="n">the</span> <span class="n">administrator</span><span class="o">.</span>
        <span class="n">Sufficient</span> <span class="n">replicas</span> <span class="n">exist</span> <span class="k">for</span> <span class="n">the</span> <span class="n">pool</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">functioning</span> <span class="ow">in</span> <span class="n">a</span>
        <span class="n">degraded</span> <span class="n">state</span><span class="o">.</span>
<span class="n">action</span><span class="p">:</span> <span class="n">Online</span> <span class="n">the</span> <span class="n">device</span> <span class="n">using</span> <span class="s1">&#39;zpool online&#39;</span> <span class="ow">or</span> <span class="n">replace</span> <span class="n">the</span> <span class="n">device</span> <span class="k">with</span>
        <span class="s1">&#39;zpool replace&#39;</span><span class="o">.</span>
  <span class="n">scan</span><span class="p">:</span> <span class="n">rebuilt</span> <span class="mf">2.13</span><span class="n">G</span> <span class="ow">in</span> <span class="mi">0</span><span class="n">h0m5s</span> <span class="k">with</span> <span class="mi">0</span> <span class="n">errors</span> <span class="n">on</span> <span class="n">Fri</span> <span class="n">Feb</span> <span class="mi">24</span> <span class="mi">23</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">59</span> <span class="mi">2017</span>
<span class="n">config</span><span class="p">:</span>

        <span class="n">NAME</span>                <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
        <span class="n">tank</span>                <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
          <span class="n">draid1</span><span class="o">-</span><span class="mi">0</span>          <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdd</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sde</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdf</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdg</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdh</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdu</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">spare</span><span class="o">-</span><span class="mi">6</span>         <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="n">sdj</span>           <span class="n">OFFLINE</span>      <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s1</span>  <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdv</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdl</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdm</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdn</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">spare</span><span class="o">-</span><span class="mi">11</span>        <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="n">sdo</span>           <span class="n">OFFLINE</span>      <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s0</span>  <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdp</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdq</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdr</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sds</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdt</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">spares</span>
          <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s0</span>      <span class="n">INUSE</span>     <span class="n">currently</span> <span class="ow">in</span> <span class="n">use</span>
          <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s1</span>      <span class="n">INUSE</span>     <span class="n">currently</span> <span class="ow">in</span> <span class="n">use</span>
</pre></div>
</div>
<p>Again, full redundancy has been restored without adding any new drive.
If another drive fails, the pool will still be able to handle IO, but
there’d be no more distributed spare to rebuild (both are in <em>INUSE</em>
state now). At this point, there’s no urgency to add a new replacement
drive because the pool can survive yet another drive failure.</p>
</div>
<div class="section" id="rebuild-for-mirror-vdev">
<h3>Rebuild for mirror vdev<a class="headerlink" href="#rebuild-for-mirror-vdev" title="Permalink to this headline">¶</a></h3>
<p>The sequential rebuild process also works for the mirror vdev, when a
drive is attached to a mirror or a mirror child vdev is replaced.</p>
<p>By default, rebuild for mirror vdev is turned off. It can be turned on
using the zfs module option <em>spa_rebuild_mirror=1</em>.</p>
</div>
<div class="section" id="rebuild-throttling">
<h3>Rebuild throttling<a class="headerlink" href="#rebuild-throttling" title="Permalink to this headline">¶</a></h3>
<p>The rebuild process may delay <em>zio</em> by <em>spa_vdev_scan_delay</em> if the
draid vdev has seen any important IO in the recent <em>spa_vdev_scan_idle</em>
period. But when a dRAID vdev has lost all redundancy, e.g. a draid2
with 2 faulted child drives, the rebuild process will go full speed by
ignoring <em>spa_vdev_scan_delay</em> and <em>spa_vdev_scan_idle</em> altogether
because the vdev is now in critical state.</p>
<p>After delaying, the rebuild zio is issued using priority
<em>ZIO_PRIORITY_SCRUB</em> for reads and <em>ZIO_PRIORITY_ASYNC_WRITE</em> for
writes. Therefore the options that control the queuing of these two IO
priorities will affect rebuild <em>zio</em> as well, for example
<em>zfs_vdev_scrub_min_active</em>, <em>zfs_vdev_scrub_max_active</em>,
<em>zfs_vdev_async_write_min_active</em>, and
<em>zfs_vdev_async_write_max_active</em>.</p>
</div>
</div>
<div class="section" id="rebalance">
<h2>Rebalance<a class="headerlink" href="#rebalance" title="Permalink to this headline">¶</a></h2>
<p>Distributed spare space can be made available again by simply replacing
any failed drive with a new drive. This process is called <em>rebalance</em>
which is essentially a <em>resilver</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zpool replace -f tank sdo sdw</span>
<span class="c1"># zpool status</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">DEGRADED</span>
<span class="n">status</span><span class="p">:</span> <span class="n">One</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">devices</span> <span class="n">has</span> <span class="n">been</span> <span class="n">taken</span> <span class="n">offline</span> <span class="n">by</span> <span class="n">the</span> <span class="n">administrator</span><span class="o">.</span>
        <span class="n">Sufficient</span> <span class="n">replicas</span> <span class="n">exist</span> <span class="k">for</span> <span class="n">the</span> <span class="n">pool</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">functioning</span> <span class="ow">in</span> <span class="n">a</span>
        <span class="n">degraded</span> <span class="n">state</span><span class="o">.</span>
<span class="n">action</span><span class="p">:</span> <span class="n">Online</span> <span class="n">the</span> <span class="n">device</span> <span class="n">using</span> <span class="s1">&#39;zpool online&#39;</span> <span class="ow">or</span> <span class="n">replace</span> <span class="n">the</span> <span class="n">device</span> <span class="k">with</span>
        <span class="s1">&#39;zpool replace&#39;</span><span class="o">.</span>
  <span class="n">scan</span><span class="p">:</span> <span class="n">resilvered</span> <span class="mf">2.21</span><span class="n">G</span> <span class="ow">in</span> <span class="mi">0</span><span class="n">h0m58s</span> <span class="k">with</span> <span class="mi">0</span> <span class="n">errors</span> <span class="n">on</span> <span class="n">Fri</span> <span class="n">Feb</span> <span class="mi">24</span> <span class="mi">23</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">45</span> <span class="mi">2017</span>
<span class="n">config</span><span class="p">:</span>

        <span class="n">NAME</span>                <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
        <span class="n">tank</span>                <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
          <span class="n">draid1</span><span class="o">-</span><span class="mi">0</span>          <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdd</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sde</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdf</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdg</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdh</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdu</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">spare</span><span class="o">-</span><span class="mi">6</span>         <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="n">sdj</span>           <span class="n">OFFLINE</span>      <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
              <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s1</span>  <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdv</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdl</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdm</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdn</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdw</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdp</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdq</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdr</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sds</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
            <span class="n">sdt</span>             <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">spares</span>
          <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s0</span>      <span class="n">AVAIL</span>
          <span class="o">%</span><span class="n">draid1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">s1</span>      <span class="n">INUSE</span>     <span class="n">currently</span> <span class="ow">in</span> <span class="n">use</span>
</pre></div>
</div>
<p>Note that the scan status now says <em>“resilvered”</em>. Also, the state of
<em>%draid1-0-s0</em> has become <em>AVAIL</em> again. Since the resilver process
checks block checksums, it makes up for the lack of checksum
verification during previous rebuild.</p>
<p>The dRAID1 vdev in this example shuffles three (4 data + 1 parity)
redundancy groups to the 17 drives. For any single drive failure, only
about 1/3 of the blocks are affected (and should be resilvered/rebuilt).
The rebuild process is able to avoid unnecessary work, but the resilver
process by default will not. The rebalance (which is essentially
resilver) can speed up a lot by setting module option
<em>zfs_no_resilver_skip</em> to 0. This feature is turned off by default
because of issue <a class="reference external" href="https://github.com/openzfs/zfs/issues/5806">#5806</a>.</p>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<p>Please report bugs to <a class="reference external" href="https://github.com/zfsonlinux/zfs/pull/10102">the dRAID
PR</a>, as long as the
code is not merged upstream.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static//img/320px-Open-ZFS-Secondary-Logo-Colour-halfsize.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Getting Started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Project and Community/index.html">Project and Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developer Resources/index.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Performance and tuning/index.html">Performance and tuning</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Basic concepts</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Checksums.html">Checksums and Their Use in ZFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="Troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">dRAID Howto</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../License.html">License</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Basic concepts</a><ul>
      <li>Previous: <a href="Troubleshooting.html" title="previous chapter">Troubleshooting</a></li>
      <li>Next: <a href="../License.html" title="next chapter">License</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, OpenZFS.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/Basics concepts/dRAID Howto.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>