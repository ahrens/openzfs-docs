
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Debian Buster Root on ZFS &#8212; OpenZFS  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Debian Stretch Root on ZFS" href="Debian Stretch Root on ZFS.html" />
    <link rel="prev" title="Debian" href="index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="debian-buster-root-on-zfs">
<h1>Debian Buster Root on ZFS<a class="headerlink" href="#debian-buster-root-on-zfs" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#caution" id="id1">Caution</a></li>
<li><a class="reference internal" href="#system-requirements" id="id2">System Requirements</a><ul>
<li><a class="reference internal" href="#support" id="id3">Support</a></li>
<li><a class="reference internal" href="#contributing" id="id4">Contributing</a></li>
<li><a class="reference internal" href="#encryption" id="id5">Encryption</a></li>
<li><a class="reference internal" href="#step-1-prepare-the-install-environment" id="id6">Step 1: Prepare The Install Environment</a></li>
<li><a class="reference internal" href="#step-2-disk-formatting" id="id7">Step 2: Disk Formatting</a></li>
<li><a class="reference internal" href="#step-3-system-installation" id="id8">Step 3: System Installation</a></li>
<li><a class="reference internal" href="#step-4-system-configuration" id="id9">Step 4: System Configuration</a></li>
<li><a class="reference internal" href="#step-5-grub-installation" id="id10">Step 5: GRUB Installation</a></li>
<li><a class="reference internal" href="#step-6-first-boot" id="id11">Step 6: First Boot</a></li>
<li><a class="reference internal" href="#step-7-optional-configure-swap" id="id12">Step 7: (Optional) Configure Swap</a></li>
<li><a class="reference internal" href="#step-8-full-software-installation" id="id13">Step 8: Full Software Installation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-9-final-cleanup" id="id14">Step 9: Final Cleanup</a><ul>
<li><a class="reference internal" href="#troubleshooting" id="id15">Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rescuing-using-a-live-cd" id="id16">Rescuing using a Live CD</a></li>
<li><a class="reference internal" href="#mpt2sas" id="id17">MPT2SAS</a></li>
<li><a class="reference internal" href="#areca" id="id18">Areca</a></li>
<li><a class="reference internal" href="#vmware" id="id19">VMware</a></li>
<li><a class="reference internal" href="#qemu-kvm-xen" id="id20">QEMU/KVM/XEN</a></li>
</ul>
</div>
<div class="section" id="caution">
<h2><a class="toc-backref" href="#id1">Caution</a><a class="headerlink" href="#caution" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>This HOWTO uses a whole physical disk.</li>
<li>Do not use these instructions for dual-booting.</li>
<li>Backup your data. Any existing data will be lost.</li>
</ul>
</div>
<div class="section" id="system-requirements">
<h2><a class="toc-backref" href="#id2">System Requirements</a><a class="headerlink" href="#system-requirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://cdimage.debian.org/mirror/cdimage/release/current-live/amd64/iso-hybrid/">64-bit Debian GNU/Linux Buster Live CD w/ GUI (e.g. gnome
iso)</a></li>
<li><a class="reference external" href="https://github.com/zfsonlinux/zfs/wiki/FAQ#32-bit-vs-64-bit-systems">A 64-bit kernel is strongly
encouraged.</a></li>
<li>Installing on a drive which presents 4KiB logical sectors (a “4Kn”
drive) only works with UEFI booting. This not unique to ZFS. <a class="reference external" href="http://savannah.gnu.org/bugs/?46700">GRUB
does not and will not work on 4Kn with legacy (BIOS)
booting.</a></li>
</ul>
<p>Computers that have less than 2 GiB of memory run ZFS slowly. 4 GiB of
memory is recommended for normal performance in basic workloads. If you
wish to use deduplication, you will need <a class="reference external" href="http://wiki.freebsd.org/ZFSTuningGuide#Deduplication">massive amounts of
RAM</a>. Enabling
deduplication is a permanent change that cannot be easily reverted.</p>
<div class="section" id="support">
<h3><a class="toc-backref" href="#id3">Support</a><a class="headerlink" href="#support" title="Permalink to this headline">¶</a></h3>
<p>If you need help, reach out to the community using the <a class="reference external" href="https://github.com/zfsonlinux/zfs/wiki/Mailing-Lists">zfs-discuss
mailing list</a>
or IRC at #zfsonlinux on <a class="reference external" href="https://freenode.net/">freenode</a>. If you
have a bug report or feature request related to this HOWTO, please <a class="reference external" href="https://github.com/zfsonlinux/zfs/issues/new">file
a new issue</a> and
mention &#64;rlaager.</p>
</div>
<div class="section" id="contributing">
<h3><a class="toc-backref" href="#id4">Contributing</a><a class="headerlink" href="#contributing" title="Permalink to this headline">¶</a></h3>
<p>Edit permission on this wiki is restricted. Also, GitHub wikis do not
support pull requests. However, you can clone the wiki using git.</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/zfsonlinux/zfs.wiki.git</span></code></li>
<li>Make your changes.</li>
<li>Use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">diff</span> <span class="pre">&gt;</span> <span class="pre">my-changes.patch</span></code> to create a patch. (Advanced git
users may wish to <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span></code> to a branch and
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">format-patch</span></code>.)</li>
<li><a class="reference external" href="https://github.com/zfsonlinux/zfs/issues/new">File a new issue</a>,
mention &#64;rlaager, and attach the patch.</li>
</ol>
</div>
<div class="section" id="encryption">
<h3><a class="toc-backref" href="#id5">Encryption</a><a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h3>
<p>This guide supports three different encryption options: unencrypted,
LUKS (full-disk encryption), and ZFS native encryption. With any option,
all ZFS features are fully available.</p>
<p>Unencrypted does not encrypt anything, of course. With no encryption
happening, this option naturally has the best performance.</p>
<p>LUKS encrypts almost everything: the OS, swap, home directories, and
anything else. The only unencrypted data is the bootloader, kernel, and
initrd. The system cannot boot without the passphrase being entered at
the console. Performance is good, but LUKS sits underneath ZFS, so if
multiple disks (mirror or raidz topologies) are used, the data has to be
encrypted once per disk.</p>
<p>ZFS native encryption encrypts the data and most metadata in the root
pool. It does not encrypt dataset or snapshot names or properties. The
boot pool is not encrypted at all, but it only contains the bootloader,
kernel, and initrd. (Unless you put a password in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>, the
initrd is unlikely to contain sensitive data.) The system cannot boot
without the passphrase being entered at the console. Performance is
good. As the encryption happens in ZFS, even if multiple disks (mirror
or raidz topologies) are used, the data only has to be encrypted once.</p>
</div>
<div class="section" id="step-1-prepare-the-install-environment">
<h3><a class="toc-backref" href="#id6">Step 1: Prepare The Install Environment</a><a class="headerlink" href="#step-1-prepare-the-install-environment" title="Permalink to this headline">¶</a></h3>
<p>1.1 Boot the Debian GNU/Linux Live CD. If prompted, login with the
username <code class="docutils literal notranslate"><span class="pre">user</span></code> and password <code class="docutils literal notranslate"><span class="pre">live</span></code>. Connect your system to the
Internet as appropriate (e.g. join your WiFi network).</p>
<p>1.2 Optional: Install and start the OpenSSH server in the Live CD
environment:</p>
<p>If you have a second system, using SSH to access the target system can
be convenient.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">--</span><span class="n">yes</span> <span class="n">openssh</span><span class="o">-</span><span class="n">server</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">ssh</span>
</pre></div>
</div>
<p><strong>Hint:</strong> You can find your IP address with
<code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">addr</span> <span class="pre">show</span> <span class="pre">scope</span> <span class="pre">global</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">inet</span></code>. Then, from your main machine,
connect with <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">user&#64;IP</span></code>.</p>
<p>1.3 Become root:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">-</span><span class="n">i</span>
</pre></div>
</div>
<p>1.4 Setup and update the repositories:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">deb</span><span class="o">.</span><span class="n">debian</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">debian</span> <span class="n">buster</span> <span class="n">contrib</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span>
<span class="n">echo</span> <span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">deb</span><span class="o">.</span><span class="n">debian</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">debian</span> <span class="n">buster</span><span class="o">-</span><span class="n">backports</span> <span class="n">main</span> <span class="n">contrib</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span>
<span class="n">apt</span> <span class="n">update</span>
</pre></div>
</div>
<p>1.5 Install ZFS in the Live CD environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>apt install --yes debootstrap gdisk dkms dpkg-dev linux-headers-$(uname -r)
apt install --yes -t buster-backports --no-install-recommends zfs-dkms
modprobe zfs
apt install --yes -t buster-backports zfsutils-linux
</pre></div>
</div>
<ul class="simple">
<li>The dkms dependency is installed manually just so it comes from
buster and not buster-backports. This is not critical.</li>
<li>We need to get the module built and loaded before installing
zfsutils-linux or <a class="reference external" href="https://github.com/zfsonlinux/zfs/issues/9599">zfs-mount.service will fail to
start</a>.</li>
</ul>
</div>
<div class="section" id="step-2-disk-formatting">
<h3><a class="toc-backref" href="#id7">Step 2: Disk Formatting</a><a class="headerlink" href="#step-2-disk-formatting" title="Permalink to this headline">¶</a></h3>
<p>2.1 Set a variable with the disk name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DISK</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk1</span>
</pre></div>
</div>
<p>Always use the long <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-id/*</span></code> aliases with ZFS. Using the
<code class="docutils literal notranslate"><span class="pre">/dev/sd*</span></code> device nodes directly can cause sporadic import failures,
especially on systems that have more than one storage pool.</p>
<p><strong>Hints:</strong></p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-la</span> <span class="pre">/dev/disk/by-id</span></code> will list the aliases.</li>
<li>Are you doing this in a virtual machine? If your virtual disk is
missing from <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-id</span></code>, use <code class="docutils literal notranslate"><span class="pre">/dev/vda</span></code> if you are using
KVM with virtio; otherwise, read the
<a class="reference external" href="#troubleshooting">troubleshooting</a> section.</li>
</ul>
<p>2.2 If you are re-using a disk, clear it as necessary:</p>
<p>If the disk was previously used in an MD array, zero the superblock:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>apt install --yes mdadm
mdadm --zero-superblock --force $DISK
</pre></div>
</div>
<p>Clear the partition table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sgdisk --zap-all $DISK
</pre></div>
</div>
<p>2.3 Partition your disk(s):</p>
<p>Run this if you need legacy (BIOS) booting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sgdisk -a1 -n1:24K:+1000K -t1:EF02 $DISK
</pre></div>
</div>
<p>Run this for UEFI booting (for use now or in the future):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sgdisk     -n2:1M:+512M   -t2:EF00 $DISK
</pre></div>
</div>
<p>Run this for the boot pool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sgdisk     -n3:0:+1G      -t3:BF01 $DISK
</pre></div>
</div>
<p>Choose one of the following options:</p>
<p>2.3a Unencrypted or ZFS native encryption:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sgdisk     -n4:0:0        -t4:BF01 $DISK
</pre></div>
</div>
<p>2.3b LUKS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sgdisk     -n4:0:0        -t4:8300 $DISK
</pre></div>
</div>
<p>If you are creating a mirror or raidz topology, repeat the partitioning
commands for all the disks which will be part of the pool.</p>
<p>2.4 Create the boot pool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>zpool create -o ashift=12 -d \
    -o feature@async_destroy=enabled \
    -o feature@bookmarks=enabled \
    -o feature@embedded_data=enabled \
    -o feature@empty_bpobj=enabled \
    -o feature@enabled_txg=enabled \
    -o feature@extensible_dataset=enabled \
    -o feature@filesystem_limits=enabled \
    -o feature@hole_birth=enabled \
    -o feature@large_blocks=enabled \
    -o feature@lz4_compress=enabled \
    -o feature@spacemap_histogram=enabled \
    -o feature@userobj_accounting=enabled \
    -o feature@zpool_checkpoint=enabled \
    -o feature@spacemap_v2=enabled \
    -o feature@project_quota=enabled \
    -o feature@resilver_defer=enabled \
    -o feature@allocation_classes=enabled \
    -O acltype=posixacl -O canmount=off -O compression=lz4 -O devices=off \
    -O normalization=formD -O relatime=on -O xattr=sa \
    -O mountpoint=/ -R /mnt bpool ${DISK}-part3
</pre></div>
</div>
<p>You should not need to customize any of the options for the boot pool.</p>
<p>GRUB does not support all of the zpool features. See
<code class="docutils literal notranslate"><span class="pre">spa_feature_names</span></code> in
<a class="reference external" href="http://git.savannah.gnu.org/cgit/grub.git/tree/grub-core/fs/zfs/zfs.c#n276">grub-core/fs/zfs/zfs.c</a>.
This step creates a separate boot pool for <code class="docutils literal notranslate"><span class="pre">/boot</span></code> with the features
limited to only those that GRUB supports, allowing the root pool to use
any/all features. Note that GRUB opens the pool read-only, so all
read-only compatible features are “supported” by GRUB.</p>
<p><strong>Hints:</strong></p>
<ul class="simple">
<li>If you are creating a mirror or raidz topology, create the pool using
<code class="docutils literal notranslate"><span class="pre">zpool</span> <span class="pre">create</span> <span class="pre">...</span> <span class="pre">bpool</span> <span class="pre">mirror</span> <span class="pre">/dev/disk/by-id/scsi-SATA_disk1-part3</span> <span class="pre">/dev/disk/by-id/scsi-SATA_disk2-part3</span></code>
(or replace <code class="docutils literal notranslate"><span class="pre">mirror</span></code> with <code class="docutils literal notranslate"><span class="pre">raidz</span></code>, <code class="docutils literal notranslate"><span class="pre">raidz2</span></code>, or <code class="docutils literal notranslate"><span class="pre">raidz3</span></code> and
list the partitions from additional disks).</li>
<li>The pool name is arbitrary. If changed, the new name must be used
consistently. The <code class="docutils literal notranslate"><span class="pre">bpool</span></code> convention originated in this HOWTO.</li>
</ul>
<p>2.5 Create the root pool:</p>
<p>Choose one of the following options:</p>
<p>2.5a Unencrypted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>zpool create -o ashift=12 \
    -O acltype=posixacl -O canmount=off -O compression=lz4 \
    -O dnodesize=auto -O normalization=formD -O relatime=on -O xattr=sa \
    -O mountpoint=/ -R /mnt rpool ${DISK}-part4
</pre></div>
</div>
<p>2.5b LUKS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>apt install --yes cryptsetup
cryptsetup luksFormat -c aes-xts-plain64 -s 512 -h sha256 ${DISK}-part4
cryptsetup luksOpen ${DISK}-part4 luks1
zpool create -o ashift=12 \
    -O acltype=posixacl -O canmount=off -O compression=lz4 \
    -O dnodesize=auto -O normalization=formD -O relatime=on -O xattr=sa \
    -O mountpoint=/ -R /mnt rpool /dev/mapper/luks1
</pre></div>
</div>
<p>2.5c ZFS native encryption:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>zpool create -o ashift=12 \
    -O acltype=posixacl -O canmount=off -O compression=lz4 \
    -O dnodesize=auto -O normalization=formD -O relatime=on -O xattr=sa \
    -O encryption=aes-256-gcm -O keylocation=prompt -O keyformat=passphrase \
    -O mountpoint=/ -R /mnt rpool ${DISK}-part4
</pre></div>
</div>
<ul class="simple">
<li>The use of <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is recommended here because many drives
today have 4KiB (or larger) physical sectors, even though they
present 512B logical sectors. Also, a future replacement drive may
have 4KiB physical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is desirable)
or 4KiB logical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is required).</li>
<li>Setting <code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">acltype=posixacl</span></code> enables POSIX ACLs globally. If you
do not want this, remove that option, but later add
<code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">acltype=posixacl</span></code> (note: lowercase “o”) to the <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">create</span></code>
for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, as <a class="reference external" href="https://askubuntu.com/questions/970886/journalctl-says-failed-to-search-journal-acl-operation-not-supported">journald requires
ACLs</a></li>
<li>Setting <code class="docutils literal notranslate"><span class="pre">normalization=formD</span></code> eliminates some corner cases relating
to UTF-8 filename normalization. It also implies <code class="docutils literal notranslate"><span class="pre">utf8only=on</span></code>,
which means that only UTF-8 filenames are allowed. If you care to
support non-UTF-8 filenames, do not use this option. For a discussion
of why requiring UTF-8 filenames may be a bad idea, see <a class="reference external" href="http://utcc.utoronto.ca/~cks/space/blog/linux/ForcedUTF8Filenames">The problems
with enforced UTF-8 only
filenames</a>.</li>
<li>Setting <code class="docutils literal notranslate"><span class="pre">relatime=on</span></code> is a middle ground between classic POSIX
<code class="docutils literal notranslate"><span class="pre">atime</span></code> behavior (with its significant performance impact) and
<code class="docutils literal notranslate"><span class="pre">atime=off</span></code> (which provides the best performance by completely
disabling atime updates). Since Linux 2.6.30, <code class="docutils literal notranslate"><span class="pre">relatime</span></code> has been
the default for other filesystems. See <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/power_management_guide/relatime">RedHat’s
documentation</a>
for further information.</li>
<li>Setting <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> <a class="reference external" href="https://github.com/zfsonlinux/zfs/commit/82a37189aac955c81a59a5ecc3400475adb56355">vastly improves the performance of extended
attributes</a>.
Inside ZFS, extended attributes are used to implement POSIX ACLs.
Extended attributes can also be used by user-space applications.
<a class="reference external" href="https://en.wikipedia.org/wiki/Extended_file_attributes#Linux">They are used by some desktop GUI
applications.</a>
<a class="reference external" href="https://wiki.samba.org/index.php/Setting_up_a_Share_Using_Windows_ACLs">They can be used by Samba to store Windows ACLs and DOS attributes;
they are required for a Samba Active Directory domain
controller.</a>
Note that <code class="docutils literal notranslate"><span class="pre">`xattr=sa</span></code> is
Linux-specific. &lt;<a class="reference external" href="http://open-zfs.org/wiki/Platform_code_differences">http://open-zfs.org/wiki/Platform_code_differences</a>&gt;`__
If you move your <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> pool to another OpenZFS implementation
besides ZFS-on-Linux, extended attributes will not be readable
(though your data will be). If portability of extended attributes is
important to you, omit the <code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">xattr=sa</span></code> above. Even if you do not
want <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> for the whole pool, it is probably fine to use it
for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>.</li>
<li>Make sure to include the <code class="docutils literal notranslate"><span class="pre">-part4</span></code> portion of the drive path. If you
forget that, you are specifying the whole disk, which ZFS will then
re-partition, and you will lose the bootloader partition(s).</li>
<li>For LUKS, the key size chosen is 512 bits. However, XTS mode requires
two keys, so the LUKS key is split in half. Thus, <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">512</span></code> means
AES-256.</li>
<li>ZFS native encryption uses <code class="docutils literal notranslate"><span class="pre">aes-256-ccm</span></code> by default. <a class="reference external" href="https://crypto.stackexchange.com/questions/6842/how-to-choose-between-aes-ccm-and-aes-gcm-for-storage-volume-encryption">AES-GCM seems
to be generally preferred over
AES-CCM</a>,
<a class="reference external" href="https://github.com/zfsonlinux/zfs/pull/9749#issuecomment-569132997">is faster
now</a>,
and <a class="reference external" href="https://github.com/zfsonlinux/zfs/pull/9749">will be even faster in the
future</a>.</li>
<li>Your passphrase will likely be the weakest link. Choose wisely. See
<a class="reference external" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#5-security-aspects">section 5 of the cryptsetup
FAQ</a>
for guidance.</li>
</ul>
<p><strong>Hints:</strong></p>
<ul class="simple">
<li>If you are creating a mirror or raidz topology, create the pool using
<code class="docutils literal notranslate"><span class="pre">zpool</span> <span class="pre">create</span> <span class="pre">...</span> <span class="pre">rpool</span> <span class="pre">mirror</span> <span class="pre">/dev/disk/by-id/scsi-SATA_disk1-part4</span> <span class="pre">/dev/disk/by-id/scsi-SATA_disk2-part4</span></code>
(or replace <code class="docutils literal notranslate"><span class="pre">mirror</span></code> with <code class="docutils literal notranslate"><span class="pre">raidz</span></code>, <code class="docutils literal notranslate"><span class="pre">raidz2</span></code>, or <code class="docutils literal notranslate"><span class="pre">raidz3</span></code> and
list the partitions from additional disks). For LUKS, use
<code class="docutils literal notranslate"><span class="pre">/dev/mapper/luks1</span></code>, <code class="docutils literal notranslate"><span class="pre">/dev/mapper/luks2</span></code>, etc., which you will
have to create using <code class="docutils literal notranslate"><span class="pre">cryptsetup</span></code>.</li>
<li>The pool name is arbitrary. If changed, the new name must be used
consistently. On systems that can automatically install to ZFS, the
root pool is named <code class="docutils literal notranslate"><span class="pre">rpool</span></code> by default.</li>
</ul>
</div>
<div class="section" id="step-3-system-installation">
<h3><a class="toc-backref" href="#id8">Step 3: System Installation</a><a class="headerlink" href="#step-3-system-installation" title="Permalink to this headline">¶</a></h3>
<p>3.1 Create filesystem datasets to act as containers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">canmount</span><span class="o">=</span><span class="n">off</span> <span class="o">-</span><span class="n">o</span> <span class="n">mountpoint</span><span class="o">=</span><span class="n">none</span> <span class="n">rpool</span><span class="o">/</span><span class="n">ROOT</span>
<span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">canmount</span><span class="o">=</span><span class="n">off</span> <span class="o">-</span><span class="n">o</span> <span class="n">mountpoint</span><span class="o">=</span><span class="n">none</span> <span class="n">bpool</span><span class="o">/</span><span class="n">BOOT</span>
</pre></div>
</div>
<p>On Solaris systems, the root filesystem is cloned and the suffix is
incremented for major system changes through <code class="docutils literal notranslate"><span class="pre">pkg</span> <span class="pre">image-update</span></code> or
<code class="docutils literal notranslate"><span class="pre">beadm</span></code>. Similar functionality for APT is possible but currently
unimplemented. Even without such a tool, it can still be used for
manually created clones.</p>
<p>3.2 Create filesystem datasets for the root and boot filesystems:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">canmount</span><span class="o">=</span><span class="n">noauto</span> <span class="o">-</span><span class="n">o</span> <span class="n">mountpoint</span><span class="o">=/</span> <span class="n">rpool</span><span class="o">/</span><span class="n">ROOT</span><span class="o">/</span><span class="n">debian</span>
<span class="n">zfs</span> <span class="n">mount</span> <span class="n">rpool</span><span class="o">/</span><span class="n">ROOT</span><span class="o">/</span><span class="n">debian</span>

<span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">canmount</span><span class="o">=</span><span class="n">noauto</span> <span class="o">-</span><span class="n">o</span> <span class="n">mountpoint</span><span class="o">=/</span><span class="n">boot</span> <span class="n">bpool</span><span class="o">/</span><span class="n">BOOT</span><span class="o">/</span><span class="n">debian</span>
<span class="n">zfs</span> <span class="n">mount</span> <span class="n">bpool</span><span class="o">/</span><span class="n">BOOT</span><span class="o">/</span><span class="n">debian</span>
</pre></div>
</div>
<p>With ZFS, it is not normally necessary to use a mount command (either
<code class="docutils literal notranslate"><span class="pre">mount</span></code> or <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">mount</span></code>). This situation is an exception because of
<code class="docutils literal notranslate"><span class="pre">canmount=noauto</span></code>.</p>
<p>3.3 Create datasets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">home</span>
<span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">mountpoint</span><span class="o">=/</span><span class="n">root</span>             <span class="n">rpool</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">root</span>
<span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">canmount</span><span class="o">=</span><span class="n">off</span>                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span>
<span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">canmount</span><span class="o">=</span><span class="n">off</span>                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span>
<span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span>
<span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span>
</pre></div>
</div>
<p>The datasets below are optional, depending on your preferences and/or
software choices.</p>
<p>If you wish to exclude these from snapshots:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="p">:</span><span class="n">auto</span><span class="o">-</span><span class="n">snapshot</span><span class="o">=</span><span class="n">false</span>  <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span>
<span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="p">:</span><span class="n">auto</span><span class="o">-</span><span class="n">snapshot</span><span class="o">=</span><span class="n">false</span>  <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span>
<span class="n">chmod</span> <span class="mi">1777</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span>
</pre></div>
</div>
<p>If you use /opt on this system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">opt</span>
</pre></div>
</div>
<p>If you use /srv on this system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">srv</span>
</pre></div>
</div>
<p>If you use /usr/local on this system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">canmount</span><span class="o">=</span><span class="n">off</span>                 <span class="n">rpool</span><span class="o">/</span><span class="n">usr</span>
<span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span>
</pre></div>
</div>
<p>If this system will have games installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">games</span>
</pre></div>
</div>
<p>If this system will store local email in /var/mail:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">mail</span>
</pre></div>
</div>
<p>If this system will use Snap packages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">snap</span>
</pre></div>
</div>
<p>If you use /var/www on this system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
</pre></div>
</div>
<p>If this system will use GNOME:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span>                                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">AccountsService</span>
</pre></div>
</div>
<p>If this system will use Docker (which manages its own datasets &amp;
snapshots):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="p">:</span><span class="n">auto</span><span class="o">-</span><span class="n">snapshot</span><span class="o">=</span><span class="n">false</span>  <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span>
</pre></div>
</div>
<p>If this system will use NFS (locking):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="p">:</span><span class="n">auto</span><span class="o">-</span><span class="n">snapshot</span><span class="o">=</span><span class="n">false</span>  <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nfs</span>
</pre></div>
</div>
<p>A tmpfs is recommended later, but if you want a separate dataset for
/tmp:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span> <span class="o">-</span><span class="n">o</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="p">:</span><span class="n">auto</span><span class="o">-</span><span class="n">snapshot</span><span class="o">=</span><span class="n">false</span>  <span class="n">rpool</span><span class="o">/</span><span class="n">tmp</span>
<span class="n">chmod</span> <span class="mi">1777</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">tmp</span>
</pre></div>
</div>
<p>The primary goal of this dataset layout is to separate the OS from user
data. This allows the root filesystem to be rolled back without rolling
back user data such as logs (in <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>). This will be especially
important if/when a <code class="docutils literal notranslate"><span class="pre">beadm</span></code> or similar utility is integrated. The
<code class="docutils literal notranslate"><span class="pre">com.sun.auto-snapshot</span></code> setting is used by some ZFS snapshot utilities
to exclude transient data.</p>
<p>If you do nothing extra, <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> will be stored as part of the root
filesystem. Alternatively, you can create a separate dataset for
<code class="docutils literal notranslate"><span class="pre">/tmp</span></code>, as shown above. This keeps the <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> data out of snapshots
of your root filesystem. It also allows you to set a quota on
<code class="docutils literal notranslate"><span class="pre">rpool/tmp</span></code>, if you want to limit the maximum space used. Otherwise,
you can use a tmpfs (RAM filesystem) later.</p>
<p>3.4 Install the minimal system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">debootstrap</span> <span class="n">buster</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">zfs</span> <span class="nb">set</span> <span class="n">devices</span><span class="o">=</span><span class="n">off</span> <span class="n">rpool</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">debootstrap</span></code> command leaves the new system in an unconfigured
state. An alternative to using <code class="docutils literal notranslate"><span class="pre">debootstrap</span></code> is to copy the entirety
of a working system into the new ZFS root.</p>
</div>
<div class="section" id="step-4-system-configuration">
<h3><a class="toc-backref" href="#id9">Step 4: System Configuration</a><a class="headerlink" href="#step-4-system-configuration" title="Permalink to this headline">¶</a></h3>
<p>4.1 Configure the hostname (change <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> to the desired
hostname).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">HOSTNAME</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hostname</span>

<span class="n">vi</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="n">Add</span> <span class="n">a</span> <span class="n">line</span><span class="p">:</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">1.1</span>       <span class="n">HOSTNAME</span>
<span class="ow">or</span> <span class="k">if</span> <span class="n">the</span> <span class="n">system</span> <span class="n">has</span> <span class="n">a</span> <span class="n">real</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">DNS</span><span class="p">:</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">1.1</span>       <span class="n">FQDN</span> <span class="n">HOSTNAME</span>
</pre></div>
</div>
<p><strong>Hint:</strong> Use <code class="docutils literal notranslate"><span class="pre">nano</span></code> if you find <code class="docutils literal notranslate"><span class="pre">vi</span></code> confusing.</p>
<p>4.2 Configure the network interface:</p>
<p>Find the interface name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="n">addr</span> <span class="n">show</span>
</pre></div>
</div>
<p>Adjust NAME below to match your interface name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">interfaces</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">NAME</span>
<span class="n">auto</span> <span class="n">NAME</span>
<span class="n">iface</span> <span class="n">NAME</span> <span class="n">inet</span> <span class="n">dhcp</span>
</pre></div>
</div>
<p>Customize this file if the system is not a DHCP client.</p>
<p>4.3 Configure the package sources:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span>
<span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">deb</span><span class="o">.</span><span class="n">debian</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">debian</span> <span class="n">buster</span> <span class="n">main</span> <span class="n">contrib</span>
<span class="n">deb</span><span class="o">-</span><span class="n">src</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">deb</span><span class="o">.</span><span class="n">debian</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">debian</span> <span class="n">buster</span> <span class="n">main</span> <span class="n">contrib</span>

<span class="n">vi</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">buster</span><span class="o">-</span><span class="n">backports</span><span class="o">.</span><span class="n">list</span>
<span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">deb</span><span class="o">.</span><span class="n">debian</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">debian</span> <span class="n">buster</span><span class="o">-</span><span class="n">backports</span> <span class="n">main</span> <span class="n">contrib</span>
<span class="n">deb</span><span class="o">-</span><span class="n">src</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">deb</span><span class="o">.</span><span class="n">debian</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">debian</span> <span class="n">buster</span><span class="o">-</span><span class="n">backports</span> <span class="n">main</span> <span class="n">contrib</span>

<span class="n">vi</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">preferences</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="mi">90</span><span class="n">_zfs</span>
<span class="n">Package</span><span class="p">:</span> <span class="n">libnvpair1linux</span> <span class="n">libuutil1linux</span> <span class="n">libzfs2linux</span> <span class="n">libzfslinux</span><span class="o">-</span><span class="n">dev</span> <span class="n">libzpool2linux</span> <span class="n">python3</span><span class="o">-</span><span class="n">pyzfs</span> <span class="n">pyzfs</span><span class="o">-</span><span class="n">doc</span> <span class="n">spl</span> <span class="n">spl</span><span class="o">-</span><span class="n">dkms</span> <span class="n">zfs</span><span class="o">-</span><span class="n">dkms</span> <span class="n">zfs</span><span class="o">-</span><span class="n">dracut</span> <span class="n">zfs</span><span class="o">-</span><span class="n">initramfs</span> <span class="n">zfs</span><span class="o">-</span><span class="n">test</span> <span class="n">zfsutils</span><span class="o">-</span><span class="n">linux</span> <span class="n">zfsutils</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">dev</span> <span class="n">zfs</span><span class="o">-</span><span class="n">zed</span>
<span class="n">Pin</span><span class="p">:</span> <span class="n">release</span> <span class="n">n</span><span class="o">=</span><span class="n">buster</span><span class="o">-</span><span class="n">backports</span>
<span class="n">Pin</span><span class="o">-</span><span class="n">Priority</span><span class="p">:</span> <span class="mi">990</span>
</pre></div>
</div>
<p>4.4 Bind the virtual filesystems from the LiveCD environment to the new
system and <code class="docutils literal notranslate"><span class="pre">chroot</span></code> into it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mount --rbind /dev  /mnt/dev
mount --rbind /proc /mnt/proc
mount --rbind /sys  /mnt/sys
chroot /mnt /usr/bin/env DISK=$DISK bash --login
</pre></div>
</div>
<p><strong>Note:</strong> This is using <code class="docutils literal notranslate"><span class="pre">--rbind</span></code>, not <code class="docutils literal notranslate"><span class="pre">--bind</span></code>.</p>
<p>4.5 Configure a basic system environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="bp">self</span><span class="o">/</span><span class="n">mounts</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mtab</span>
<span class="n">apt</span> <span class="n">update</span>

<span class="n">apt</span> <span class="n">install</span> <span class="o">--</span><span class="n">yes</span> <span class="n">locales</span>
<span class="n">dpkg</span><span class="o">-</span><span class="n">reconfigure</span> <span class="n">locales</span>
</pre></div>
</div>
<p>Even if you prefer a non-English system language, always ensure that
<code class="docutils literal notranslate"><span class="pre">en_US.UTF-8</span></code> is available.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dpkg</span><span class="o">-</span><span class="n">reconfigure</span> <span class="n">tzdata</span>
</pre></div>
</div>
<p>4.6 Install ZFS in the chroot environment for the new system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="o">--</span><span class="n">yes</span> <span class="n">dpkg</span><span class="o">-</span><span class="n">dev</span> <span class="n">linux</span><span class="o">-</span><span class="n">headers</span><span class="o">-</span><span class="n">amd64</span> <span class="n">linux</span><span class="o">-</span><span class="n">image</span><span class="o">-</span><span class="n">amd64</span>
<span class="n">apt</span> <span class="n">install</span> <span class="o">--</span><span class="n">yes</span> <span class="n">zfs</span><span class="o">-</span><span class="n">initramfs</span>
</pre></div>
</div>
<p>4.7 For LUKS installs only, setup crypttab:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>apt install --yes cryptsetup

echo luks1 UUID=$(blkid -s UUID -o value ${DISK}-part4) none \
    luks,discard,initramfs &gt; /etc/crypttab
</pre></div>
</div>
<ul class="simple">
<li>The use of <code class="docutils literal notranslate"><span class="pre">initramfs</span></code> is a work-around for <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/cryptsetup/+bug/1612906">cryptsetup does not
support
ZFS</a>.</li>
</ul>
<p><strong>Hint:</strong> If you are creating a mirror or raidz topology, repeat the
<code class="docutils literal notranslate"><span class="pre">/etc/crypttab</span></code> entries for <code class="docutils literal notranslate"><span class="pre">luks2</span></code>, etc. adjusting for each disk.</p>
<p>4.8 Install GRUB</p>
<p>Choose one of the following options:</p>
<p>4.8a Install GRUB for legacy (BIOS) booting</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="o">--</span><span class="n">yes</span> <span class="n">grub</span><span class="o">-</span><span class="n">pc</span>
</pre></div>
</div>
<p>Install GRUB to the disk(s), not the partition(s).</p>
<p>4.8b Install GRUB for UEFI booting</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>apt install dosfstools
mkdosfs -F 32 -s 1 -n EFI ${DISK}-part2
mkdir /boot/efi
echo PARTUUID=$(blkid -s PARTUUID -o value ${DISK}-part2) \
    /boot/efi vfat nofail,x-systemd.device-timeout=1 0 1 &gt;&gt; /etc/fstab
mount /boot/efi
apt install --yes grub-efi-amd64 shim-signed
</pre></div>
</div>
<ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">1</span></code> for <code class="docutils literal notranslate"><span class="pre">mkdosfs</span></code> is only necessary for drives which
present 4 KiB logical sectors (“4Kn” drives) to meet the minimum
cluster size (given the partition size of 512 MiB) for FAT32. It also
works fine on drives which present 512 B sectors.</li>
</ul>
<p><strong>Note:</strong> If you are creating a mirror or raidz topology, this step only
installs GRUB on the first disk. The other disk(s) will be handled
later.</p>
<p>4.9 Set a root password</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">passwd</span>
</pre></div>
</div>
<p>4.10 Enable importing bpool</p>
<p>This ensures that <code class="docutils literal notranslate"><span class="pre">bpool</span></code> is always imported, regardless of whether
<code class="docutils literal notranslate"><span class="pre">/etc/zfs/zpool.cache</span></code> exists, whether it is in the cachefile or not,
or whether <code class="docutils literal notranslate"><span class="pre">zfs-import-scan.service</span></code> is enabled.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">zfs</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">bpool</span><span class="o">.</span><span class="n">service</span>
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">DefaultDependencies</span><span class="o">=</span><span class="n">no</span>
<span class="n">Before</span><span class="o">=</span><span class="n">zfs</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">scan</span><span class="o">.</span><span class="n">service</span>
<span class="n">Before</span><span class="o">=</span><span class="n">zfs</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">cache</span><span class="o">.</span><span class="n">service</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">oneshot</span>
<span class="n">RemainAfterExit</span><span class="o">=</span><span class="n">yes</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">sbin</span><span class="o">/</span><span class="n">zpool</span> <span class="kn">import</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">o</span> <span class="n">cachefile</span><span class="o">=</span><span class="n">none</span> <span class="n">bpool</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">zfs</span><span class="o">-</span><span class="n">import</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">zfs</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">bpool</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<p>4.11 Optional (but recommended): Mount a tmpfs to /tmp</p>
<p>If you chose to create a <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> dataset above, skip this step, as they
are mutually exclusive choices. Otherwise, you can put <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> on a
tmpfs (RAM filesystem) by enabling the <code class="docutils literal notranslate"><span class="pre">tmp.mount</span></code> unit.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">tmp</span><span class="o">.</span><span class="n">mount</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">tmp</span><span class="o">.</span><span class="n">mount</span>
</pre></div>
</div>
<p>4.12 Optional (but kindly requested): Install popcon</p>
<p>The <code class="docutils literal notranslate"><span class="pre">popularity-contest</span></code> package reports the list of packages install
on your system. Showing that ZFS is popular may be helpful in terms of
long-term attention from the distro.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="o">--</span><span class="n">yes</span> <span class="n">popularity</span><span class="o">-</span><span class="n">contest</span>
</pre></div>
</div>
<p>Choose Yes at the prompt.</p>
</div>
<div class="section" id="step-5-grub-installation">
<h3><a class="toc-backref" href="#id10">Step 5: GRUB Installation</a><a class="headerlink" href="#step-5-grub-installation" title="Permalink to this headline">¶</a></h3>
<p>5.1 Verify that the ZFS boot filesystem is recognized:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grub</span><span class="o">-</span><span class="n">probe</span> <span class="o">/</span><span class="n">boot</span>
</pre></div>
</div>
<p>5.2 Refresh the initrd files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">update</span><span class="o">-</span><span class="n">initramfs</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">k</span> <span class="nb">all</span>
</pre></div>
</div>
<p><strong>Note:</strong> When using LUKS, this will print “WARNING could not determine
root device from /etc/fstab”. This is because <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/cryptsetup/+bug/1612906">cryptsetup does not
support
ZFS</a>.</p>
<p>5.3 Workaround GRUB’s missing zpool-features support:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">grub</span>
<span class="n">Set</span><span class="p">:</span> <span class="n">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;root=ZFS=rpool/ROOT/debian&quot;</span>
</pre></div>
</div>
<p>5.4 Optional (but highly recommended): Make debugging GRUB easier:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">grub</span>
<span class="n">Remove</span> <span class="n">quiet</span> <span class="n">from</span><span class="p">:</span> <span class="n">GRUB_CMDLINE_LINUX_DEFAULT</span>
<span class="n">Uncomment</span><span class="p">:</span> <span class="n">GRUB_TERMINAL</span><span class="o">=</span><span class="n">console</span>
<span class="n">Save</span> <span class="ow">and</span> <span class="n">quit</span><span class="o">.</span>
</pre></div>
</div>
<p>Later, once the system has rebooted twice and you are sure everything is
working, you can undo these changes, if desired.</p>
<p>5.5 Update the boot configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">update</span><span class="o">-</span><span class="n">grub</span>
</pre></div>
</div>
<p><strong>Note:</strong> Ignore errors from <code class="docutils literal notranslate"><span class="pre">osprober</span></code>, if present.</p>
<p>5.6 Install the boot loader</p>
<p>5.6a For legacy (BIOS) booting, install GRUB to the MBR:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>grub-install $DISK
</pre></div>
</div>
<p>Note that you are installing GRUB to the whole disk, not a partition.</p>
<p>If you are creating a mirror or raidz topology, repeat the
<code class="docutils literal notranslate"><span class="pre">grub-install</span></code> command for each disk in the pool.</p>
<p>5.6b For UEFI booting, install GRUB:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grub</span><span class="o">-</span><span class="n">install</span> <span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">x86_64</span><span class="o">-</span><span class="n">efi</span> <span class="o">--</span><span class="n">efi</span><span class="o">-</span><span class="n">directory</span><span class="o">=/</span><span class="n">boot</span><span class="o">/</span><span class="n">efi</span> \
    <span class="o">--</span><span class="n">bootloader</span><span class="o">-</span><span class="nb">id</span><span class="o">=</span><span class="n">debian</span> <span class="o">--</span><span class="n">recheck</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">floppy</span>
</pre></div>
</div>
<p>It is not necessary to specify the disk here. If you are creating a
mirror or raidz topology, the additional disks will be handled later.</p>
<p>5.7 Verify that the ZFS module is installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">grub</span><span class="o">/*/</span><span class="n">zfs</span><span class="o">.</span><span class="n">mod</span>
</pre></div>
</div>
<p>5.8 Fix filesystem mount ordering</p>
<p>Until there is support for mounting <code class="docutils literal notranslate"><span class="pre">/boot</span></code> in the initramfs, we also
need to mount that, because it was marked <code class="docutils literal notranslate"><span class="pre">canmount=noauto</span></code>. Also,
with UEFI, we need to ensure it is mounted before its child filesystem
<code class="docutils literal notranslate"><span class="pre">/boot/efi</span></code>.</p>
<p>We need to activate <code class="docutils literal notranslate"><span class="pre">zfs-mount-generator</span></code>. This makes systemd aware of
the separate mountpoints, which is important for things like
<code class="docutils literal notranslate"><span class="pre">/var/log</span></code> and <code class="docutils literal notranslate"><span class="pre">/var/tmp</span></code>. In turn, <code class="docutils literal notranslate"><span class="pre">rsyslog.service</span></code> depends on
<code class="docutils literal notranslate"><span class="pre">var-log.mount</span></code> by way of <code class="docutils literal notranslate"><span class="pre">local-fs.target</span></code> and services using the
<code class="docutils literal notranslate"><span class="pre">PrivateTmp</span></code> feature of systemd automatically use
<code class="docutils literal notranslate"><span class="pre">After=var-tmp.mount</span></code>.</p>
<p>For UEFI booting, unmount /boot/efi first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">umount</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">efi</span>
</pre></div>
</div>
<p>Everything else applies to both BIOS and UEFI booting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="nb">set</span> <span class="n">mountpoint</span><span class="o">=</span><span class="n">legacy</span> <span class="n">bpool</span><span class="o">/</span><span class="n">BOOT</span><span class="o">/</span><span class="n">debian</span>
<span class="n">echo</span> <span class="n">bpool</span><span class="o">/</span><span class="n">BOOT</span><span class="o">/</span><span class="n">debian</span> <span class="o">/</span><span class="n">boot</span> <span class="n">zfs</span> \
    <span class="n">nodev</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="n">systemd</span><span class="o">.</span><span class="n">requires</span><span class="o">=</span><span class="n">zfs</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">bpool</span><span class="o">.</span><span class="n">service</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>

<span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zfs</span><span class="o">/</span><span class="n">zfs</span><span class="o">-</span><span class="nb">list</span><span class="o">.</span><span class="n">cache</span>
<span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zfs</span><span class="o">/</span><span class="n">zfs</span><span class="o">-</span><span class="nb">list</span><span class="o">.</span><span class="n">cache</span><span class="o">/</span><span class="n">rpool</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">zfs</span><span class="o">-</span><span class="n">linux</span><span class="o">/</span><span class="n">zed</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">history_event</span><span class="o">-</span><span class="n">zfs</span><span class="o">-</span><span class="nb">list</span><span class="o">-</span><span class="n">cacher</span><span class="o">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zfs</span><span class="o">/</span><span class="n">zed</span><span class="o">.</span><span class="n">d</span>
<span class="n">zed</span> <span class="o">-</span><span class="n">F</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>Verify that zed updated the cache by making sure this is not empty:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zfs</span><span class="o">/</span><span class="n">zfs</span><span class="o">-</span><span class="nb">list</span><span class="o">.</span><span class="n">cache</span><span class="o">/</span><span class="n">rpool</span>
</pre></div>
</div>
<p>If it is empty, force a cache update and check again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="nb">set</span> <span class="n">canmount</span><span class="o">=</span><span class="n">noauto</span> <span class="n">rpool</span><span class="o">/</span><span class="n">ROOT</span><span class="o">/</span><span class="n">debian</span>
</pre></div>
</div>
<p>Stop zed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fg</span>
<span class="n">Press</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span><span class="o">.</span>
</pre></div>
</div>
<p>Fix the paths to eliminate /mnt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sed</span> <span class="o">-</span><span class="n">Ei</span> <span class="s2">&quot;s|/mnt/?|/|&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zfs</span><span class="o">/</span><span class="n">zfs</span><span class="o">-</span><span class="nb">list</span><span class="o">.</span><span class="n">cache</span><span class="o">/</span><span class="n">rpool</span>
</pre></div>
</div>
</div>
<div class="section" id="step-6-first-boot">
<h3><a class="toc-backref" href="#id11">Step 6: First Boot</a><a class="headerlink" href="#step-6-first-boot" title="Permalink to this headline">¶</a></h3>
<p>6.1 Snapshot the initial installation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">snapshot</span> <span class="n">bpool</span><span class="o">/</span><span class="n">BOOT</span><span class="o">/</span><span class="n">debian</span><span class="nd">@install</span>
<span class="n">zfs</span> <span class="n">snapshot</span> <span class="n">rpool</span><span class="o">/</span><span class="n">ROOT</span><span class="o">/</span><span class="n">debian</span><span class="nd">@install</span>
</pre></div>
</div>
<p>In the future, you will likely want to take snapshots before each
upgrade, and remove old snapshots (including this one) at some point to
save space.</p>
<p>6.2 Exit from the <code class="docutils literal notranslate"><span class="pre">chroot</span></code> environment back to the LiveCD environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exit</span>
</pre></div>
</div>
<p>6.3 Run these commands in the LiveCD environment to unmount all
filesystems:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">zfs</span> <span class="o">|</span> <span class="n">tac</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;/\/mnt/ {print $3}&#39;</span> <span class="o">|</span> <span class="n">xargs</span> <span class="o">-</span><span class="n">i</span><span class="p">{}</span> <span class="n">umount</span> <span class="o">-</span><span class="n">lf</span> <span class="p">{}</span>
<span class="n">zpool</span> <span class="n">export</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
<p>6.4 Reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reboot</span>
</pre></div>
</div>
<p>6.5 Wait for the newly installed system to boot normally. Login as root.</p>
<p>6.6 Create a user account:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zfs</span> <span class="n">create</span> <span class="n">rpool</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">YOURUSERNAME</span>
<span class="n">adduser</span> <span class="n">YOURUSERNAME</span>
<span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">skel</span><span class="o">/.</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">YOURUSERNAME</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">YOURUSERNAME</span><span class="p">:</span><span class="n">YOURUSERNAME</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">YOURUSERNAME</span>
</pre></div>
</div>
<p>6.7 Add your user account to the default set of groups for an
administrator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usermod</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">G</span> <span class="n">audio</span><span class="p">,</span><span class="n">cdrom</span><span class="p">,</span><span class="n">dip</span><span class="p">,</span><span class="n">floppy</span><span class="p">,</span><span class="n">netdev</span><span class="p">,</span><span class="n">plugdev</span><span class="p">,</span><span class="n">sudo</span><span class="p">,</span><span class="n">video</span> <span class="n">YOURUSERNAME</span>
</pre></div>
</div>
<p>6.8 Mirror GRUB</p>
<p>If you installed to multiple disks, install GRUB on the additional
disks:</p>
<p>6.8a For legacy (BIOS) booting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dpkg</span><span class="o">-</span><span class="n">reconfigure</span> <span class="n">grub</span><span class="o">-</span><span class="n">pc</span>
<span class="n">Hit</span> <span class="n">enter</span> <span class="n">until</span> <span class="n">you</span> <span class="n">get</span> <span class="n">to</span> <span class="n">the</span> <span class="n">device</span> <span class="n">selection</span> <span class="n">screen</span><span class="o">.</span>
<span class="n">Select</span> <span class="p">(</span><span class="n">using</span> <span class="n">the</span> <span class="n">space</span> <span class="n">bar</span><span class="p">)</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">disks</span> <span class="p">(</span><span class="ow">not</span> <span class="n">partitions</span><span class="p">)</span> <span class="ow">in</span> <span class="n">your</span> <span class="n">pool</span><span class="o">.</span>
</pre></div>
</div>
<p>6.8b UEFI</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">umount</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">efi</span>
</pre></div>
</div>
<p>For the second and subsequent disks (increment debian-2 to -3, etc.):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk1</span><span class="o">-</span><span class="n">part2</span> \
   <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk2</span><span class="o">-</span><span class="n">part2</span>
<span class="n">efibootmgr</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk2</span> \
    <span class="o">-</span><span class="n">p</span> <span class="mi">2</span> <span class="o">-</span><span class="n">L</span> <span class="s2">&quot;debian-2&quot;</span> <span class="o">-</span><span class="n">l</span> <span class="s1">&#39;\EFI\debian\grubx64.efi&#39;</span>

<span class="n">mount</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">efi</span>
</pre></div>
</div>
</div>
<div class="section" id="step-7-optional-configure-swap">
<h3><a class="toc-backref" href="#id12">Step 7: (Optional) Configure Swap</a><a class="headerlink" href="#step-7-optional-configure-swap" title="Permalink to this headline">¶</a></h3>
<p><strong>Caution</strong>: On systems with extremely high memory pressure, using a
zvol for swap can result in lockup, regardless of how much swap is still
available. This issue is currently being investigated in:
<a class="reference external" href="https://github.com/zfsonlinux/zfs/issues/7734">https://github.com/zfsonlinux/zfs/issues/7734</a></p>
<p>7.1 Create a volume dataset (zvol) for use as a swap device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>zfs create -V 4G -b $(getconf PAGESIZE) -o compression=zle \
    -o logbias=throughput -o sync=always \
    -o primarycache=metadata -o secondarycache=none \
    -o com.sun:auto-snapshot=false rpool/swap
</pre></div>
</div>
<p>You can adjust the size (the <code class="docutils literal notranslate"><span class="pre">4G</span></code> part) to your needs.</p>
<p>The compression algorithm is set to <code class="docutils literal notranslate"><span class="pre">zle</span></code> because it is the cheapest
available algorithm. As this guide recommends <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> (4 kiB
blocks on disk), the common case of a 4 kiB page size means that no
compression algorithm can reduce I/O. The exception is all-zero pages,
which are dropped by ZFS; but some form of compression has to be enabled
to get this behavior.</p>
<p>7.2 Configure the swap device:</p>
<p><strong>Caution</strong>: Always use long <code class="docutils literal notranslate"><span class="pre">/dev/zvol</span></code> aliases in configuration
files. Never use a short <code class="docutils literal notranslate"><span class="pre">/dev/zdX</span></code> device name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkswap</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">zvol</span><span class="o">/</span><span class="n">rpool</span><span class="o">/</span><span class="n">swap</span>
<span class="n">echo</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">zvol</span><span class="o">/</span><span class="n">rpool</span><span class="o">/</span><span class="n">swap</span> <span class="n">none</span> <span class="n">swap</span> <span class="n">discard</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
<span class="n">echo</span> <span class="n">RESUME</span><span class="o">=</span><span class="n">none</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">initramfs</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">resume</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">RESUME=none</span></code> is necessary to disable resuming from hibernation.
This does not work, as the zvol is not present (because the pool has not
yet been imported) at the time the resume script runs. If it is not
disabled, the boot process hangs for 30 seconds waiting for the swap
zvol to appear.</p>
<p>7.3 Enable the swap device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swapon</span> <span class="o">-</span><span class="n">av</span>
</pre></div>
</div>
</div>
<div class="section" id="step-8-full-software-installation">
<h3><a class="toc-backref" href="#id13">Step 8: Full Software Installation</a><a class="headerlink" href="#step-8-full-software-installation" title="Permalink to this headline">¶</a></h3>
<p>8.1 Upgrade the minimal system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">dist</span><span class="o">-</span><span class="n">upgrade</span> <span class="o">--</span><span class="n">yes</span>
</pre></div>
</div>
<p>8.2 Install a regular set of software:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tasksel</span>
</pre></div>
</div>
<p>8.3 Optional: Disable log compression:</p>
<p>As <code class="docutils literal notranslate"><span class="pre">/var/log</span></code> is already compressed by ZFS, logrotate’s compression is
going to burn CPU and disk I/O for (in most cases) very little gain.
Also, if you are making snapshots of <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, logrotate’s
compression will actually waste space, as the uncompressed data will
live on in the snapshot. You can edit the files in <code class="docutils literal notranslate"><span class="pre">/etc/logrotate.d</span></code>
by hand to comment out <code class="docutils literal notranslate"><span class="pre">compress</span></code>, or use this loop (copy-and-paste
highly recommended):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">logrotate</span><span class="o">.</span><span class="n">d</span><span class="o">/*</span> <span class="p">;</span> <span class="n">do</span>
    <span class="k">if</span> <span class="n">grep</span> <span class="o">-</span><span class="n">Eq</span> <span class="s2">&quot;(^|[^#y])compress&quot;</span> <span class="s2">&quot;$file&quot;</span> <span class="p">;</span> <span class="n">then</span>
        <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;s/(^|[^#y])(compress)/</span><span class="se">\1</span><span class="s2">#</span><span class="se">\2</span><span class="s2">/&quot;</span> <span class="s2">&quot;$file&quot;</span>
    <span class="n">fi</span>
<span class="n">done</span>
</pre></div>
</div>
<p>8.4 Reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reboot</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-9-final-cleanup">
<h2><a class="toc-backref" href="#id14">Step 9: Final Cleanup</a><a class="headerlink" href="#step-9-final-cleanup" title="Permalink to this headline">¶</a></h2>
<p>9.1 Wait for the system to boot normally. Login using the account you
created. Ensure the system (including networking) works normally.</p>
<p>9.2 Optional: Delete the snapshots of the initial installation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">zfs</span> <span class="n">destroy</span> <span class="n">bpool</span><span class="o">/</span><span class="n">BOOT</span><span class="o">/</span><span class="n">debian</span><span class="nd">@install</span>
<span class="n">sudo</span> <span class="n">zfs</span> <span class="n">destroy</span> <span class="n">rpool</span><span class="o">/</span><span class="n">ROOT</span><span class="o">/</span><span class="n">debian</span><span class="nd">@install</span>
</pre></div>
</div>
<p>9.3 Optional: Disable the root password</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">usermod</span> <span class="o">-</span><span class="n">p</span> <span class="s1">&#39;*&#39;</span> <span class="n">root</span>
</pre></div>
</div>
<p>9.4 Optional: Re-enable the graphical boot process:</p>
<p>If you prefer the graphical boot process, you can re-enable it now. If
you are using LUKS, it makes the prompt look nicer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">grub</span>
<span class="n">Add</span> <span class="n">quiet</span> <span class="n">to</span> <span class="n">GRUB_CMDLINE_LINUX_DEFAULT</span>
<span class="n">Comment</span> <span class="n">out</span> <span class="n">GRUB_TERMINAL</span><span class="o">=</span><span class="n">console</span>
<span class="n">Save</span> <span class="ow">and</span> <span class="n">quit</span><span class="o">.</span>

<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">grub</span>
</pre></div>
</div>
<p><strong>Note:</strong> Ignore errors from <code class="docutils literal notranslate"><span class="pre">osprober</span></code>, if present.</p>
<p>9.5 Optional: For LUKS installs only, backup the LUKS header:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cryptsetup</span> <span class="n">luksHeaderBackup</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk1</span><span class="o">-</span><span class="n">part4</span> \
    <span class="o">--</span><span class="n">header</span><span class="o">-</span><span class="n">backup</span><span class="o">-</span><span class="n">file</span> <span class="n">luks1</span><span class="o">-</span><span class="n">header</span><span class="o">.</span><span class="n">dat</span>
</pre></div>
</div>
<p>Store that backup somewhere safe (e.g. cloud storage). It is protected
by your LUKS passphrase, but you may wish to use additional encryption.</p>
<p><strong>Hint:</strong> If you created a mirror or raidz topology, repeat this for
each LUKS volume (<code class="docutils literal notranslate"><span class="pre">luks2</span></code>, etc.).</p>
<div class="section" id="troubleshooting">
<h3><a class="toc-backref" href="#id15">Troubleshooting</a><a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="rescuing-using-a-live-cd">
<h2><a class="toc-backref" href="#id16">Rescuing using a Live CD</a><a class="headerlink" href="#rescuing-using-a-live-cd" title="Permalink to this headline">¶</a></h2>
<p>Go through <a class="reference external" href="#step-1-prepare-the-install-environment">Step 1: Prepare The Install
Environment</a>.</p>
<p>For LUKS, first unlock the disk(s):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="o">--</span><span class="n">yes</span> <span class="n">cryptsetup</span>
<span class="n">cryptsetup</span> <span class="n">luksOpen</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk1</span><span class="o">-</span><span class="n">part4</span> <span class="n">luks1</span>
<span class="n">Repeat</span> <span class="k">for</span> <span class="n">additional</span> <span class="n">disks</span><span class="p">,</span> <span class="k">if</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">mirror</span> <span class="ow">or</span> <span class="n">raidz</span> <span class="n">topology</span><span class="o">.</span>
</pre></div>
</div>
<p>Mount everything correctly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zpool</span> <span class="n">export</span> <span class="o">-</span><span class="n">a</span>
<span class="n">zpool</span> <span class="kn">import</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">R</span> <span class="o">/</span><span class="n">mnt</span> <span class="n">rpool</span>
<span class="n">zpool</span> <span class="kn">import</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">R</span> <span class="o">/</span><span class="n">mnt</span> <span class="n">bpool</span>
<span class="n">zfs</span> <span class="n">load</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">a</span>
<span class="n">zfs</span> <span class="n">mount</span> <span class="n">rpool</span><span class="o">/</span><span class="n">ROOT</span><span class="o">/</span><span class="n">debian</span>
<span class="n">zfs</span> <span class="n">mount</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
<p>If needed, you can chroot into your installed environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">--</span><span class="n">rbind</span> <span class="o">/</span><span class="n">dev</span>  <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">dev</span>
<span class="n">mount</span> <span class="o">--</span><span class="n">rbind</span> <span class="o">/</span><span class="n">proc</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">proc</span>
<span class="n">mount</span> <span class="o">--</span><span class="n">rbind</span> <span class="o">/</span><span class="n">sys</span>  <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">sys</span>
<span class="n">chroot</span> <span class="o">/</span><span class="n">mnt</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">--</span><span class="n">login</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">boot</span>
<span class="n">mount</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
<p>Do whatever you need to do to fix your system.</p>
<p>When done, cleanup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exit</span>
<span class="n">mount</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">zfs</span> <span class="o">|</span> <span class="n">tac</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;/\/mnt/ {print $3}&#39;</span> <span class="o">|</span> <span class="n">xargs</span> <span class="o">-</span><span class="n">i</span><span class="p">{}</span> <span class="n">umount</span> <span class="o">-</span><span class="n">lf</span> <span class="p">{}</span>
<span class="n">zpool</span> <span class="n">export</span> <span class="o">-</span><span class="n">a</span>
<span class="n">reboot</span>
</pre></div>
</div>
</div>
<div class="section" id="mpt2sas">
<h2><a class="toc-backref" href="#id17">MPT2SAS</a><a class="headerlink" href="#mpt2sas" title="Permalink to this headline">¶</a></h2>
<p>Most problem reports for this tutorial involve <code class="docutils literal notranslate"><span class="pre">mpt2sas</span></code> hardware that
does slow asynchronous drive initialization, like some IBM M1015 or
OEM-branded cards that have been flashed to the reference LSI firmware.</p>
<p>The basic problem is that disks on these controllers are not visible to
the Linux kernel until after the regular system is started, and ZoL does
not hotplug pool members. See
<a class="reference external" href="https://github.com/zfsonlinux/zfs/issues/330">https://github.com/zfsonlinux/zfs/issues/330</a>.</p>
<p>Most LSI cards are perfectly compatible with ZoL. If your card has this
glitch, try setting ZFS_INITRD_PRE_MOUNTROOT_SLEEP=X in
/etc/default/zfs. The system will wait X seconds for all drives to
appear before importing the pool.</p>
</div>
<div class="section" id="areca">
<h2><a class="toc-backref" href="#id18">Areca</a><a class="headerlink" href="#areca" title="Permalink to this headline">¶</a></h2>
<p>Systems that require the <code class="docutils literal notranslate"><span class="pre">arcsas</span></code> blob driver should add it to the
<code class="docutils literal notranslate"><span class="pre">/etc/initramfs-tools/modules</span></code> file and run
<code class="docutils literal notranslate"><span class="pre">update-initramfs</span> <span class="pre">-u</span> <span class="pre">-k</span> <span class="pre">all</span></code>.</p>
<p>Upgrade or downgrade the Areca driver if something like
<code class="docutils literal notranslate"><span class="pre">RIP:</span> <span class="pre">0010:[&lt;ffffffff8101b316&gt;]</span>&#160; <span class="pre">[&lt;ffffffff8101b316&gt;]</span> <span class="pre">native_read_tsc+0x6/0x20</span></code>
appears anywhere in kernel log. ZoL is unstable on systems that emit
this error message.</p>
</div>
<div class="section" id="vmware">
<h2><a class="toc-backref" href="#id19">VMware</a><a class="headerlink" href="#vmware" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Set <code class="docutils literal notranslate"><span class="pre">disk.EnableUUID</span> <span class="pre">=</span> <span class="pre">&quot;TRUE&quot;</span></code> in the vmx file or vsphere
configuration. Doing this ensures that <code class="docutils literal notranslate"><span class="pre">/dev/disk</span></code> aliases are
created in the guest.</li>
</ul>
</div>
<div class="section" id="qemu-kvm-xen">
<h2><a class="toc-backref" href="#id20">QEMU/KVM/XEN</a><a class="headerlink" href="#qemu-kvm-xen" title="Permalink to this headline">¶</a></h2>
<p>Set a unique serial number on each virtual disk using libvirt or qemu
(e.g. <code class="docutils literal notranslate"><span class="pre">-drive</span> <span class="pre">if=none,id=disk1,file=disk1.qcow2,serial=1234567890</span></code>).</p>
<p>To be able to use UEFI in guests (instead of only BIOS booting), run
this on the host:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">ovmf</span>

<span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">qemu</span><span class="o">.</span><span class="n">conf</span>
<span class="n">Uncomment</span> <span class="n">these</span> <span class="n">lines</span><span class="p">:</span>
<span class="n">nvram</span> <span class="o">=</span> <span class="p">[</span>
   <span class="s2">&quot;/usr/share/OVMF/OVMF_CODE.fd:/usr/share/OVMF/OVMF_VARS.fd&quot;</span><span class="p">,</span>
   <span class="s2">&quot;/usr/share/OVMF/OVMF_CODE.secboot.fd:/usr/share/OVMF/OVMF_VARS.fd&quot;</span><span class="p">,</span>
   <span class="s2">&quot;/usr/share/AAVMF/AAVMF_CODE.fd:/usr/share/AAVMF/AAVMF_VARS.fd&quot;</span><span class="p">,</span>
   <span class="s2">&quot;/usr/share/AAVMF/AAVMF32_CODE.fd:/usr/share/AAVMF/AAVMF32_VARS.fd&quot;</span>
<span class="p">]</span>

<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">libvirtd</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static//img/320px-Open-ZFS-Secondary-Logo-Colour-halfsize.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference external" href="https://wiki.archlinux.org/index.php/ZFS">ArchLinux</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Debian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fedora.html">Fedora</a></li>
<li class="toctree-l2"><a class="reference external" href="https://zfsonfreebsd.github.io/ZoF/">FreeBSD</a></li>
<li class="toctree-l2"><a class="reference external" href="https://wiki.gentoo.org/wiki/ZFS">Gentoo</a></li>
<li class="toctree-l2"><a class="reference external" href="https://software.opensuse.org/package/zfs">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../RHEL and CentOS.html">RHEL and CentOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Ubuntu/index.html">Ubuntu</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Project and Community/index.html">Project and Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Developer Resources/index.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Performance and tuning/index.html">Performance and tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Basics concepts/index.html">Basic concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../License.html">License</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Getting Started</a><ul>
  <li><a href="index.html">Debian</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Debian</a></li>
      <li>Next: <a href="Debian Stretch Root on ZFS.html" title="next chapter">Debian Stretch Root on ZFS</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, OpenZFS.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/Getting Started/Debian/Debian Buster Root on ZFS.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>