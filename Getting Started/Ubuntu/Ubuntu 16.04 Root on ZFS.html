
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Ubuntu 16.04 Root on ZFS &#8212; OpenZFS  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Ubuntu 18.04 Root on ZFS" href="Ubuntu 18.04 Root on ZFS.html" />
    <link rel="prev" title="Ubuntu" href="index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="ubuntu-16-04-root-on-zfs">
<h1>Ubuntu 16.04 Root on ZFS<a class="headerlink" href="#ubuntu-16-04-root-on-zfs" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#newer-release-available" id="id1">Newer release available</a></li>
<li><a class="reference internal" href="#caution" id="id2">Caution</a></li>
<li><a class="reference internal" href="#system-requirements" id="id3">System Requirements</a><ul>
<li><a class="reference internal" href="#support" id="id4">Support</a></li>
<li><a class="reference internal" href="#encryption" id="id5">Encryption</a></li>
<li><a class="reference internal" href="#step-1-prepare-the-install-environment" id="id6">Step 1: Prepare The Install Environment</a></li>
<li><a class="reference internal" href="#step-2-disk-formatting" id="id7">Step 2: Disk Formatting</a></li>
<li><a class="reference internal" href="#step-3-system-installation" id="id8">Step 3: System Installation</a></li>
<li><a class="reference internal" href="#step-4-system-configuration" id="id9">Step 4: System Configuration</a></li>
<li><a class="reference internal" href="#step-5-grub-installation" id="id10">Step 5: GRUB Installation</a></li>
<li><a class="reference internal" href="#step-6-first-boot" id="id11">Step 6: First Boot</a></li>
<li><a class="reference internal" href="#step-7-configure-swap" id="id12">Step 7: Configure Swap</a></li>
<li><a class="reference internal" href="#step-8-full-software-installation" id="id13">Step 8: Full Software Installation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-9-final-cleanup" id="id14">Step 9: Final Cleanup</a><ul>
<li><a class="reference internal" href="#troubleshooting" id="id15">Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rescuing-using-a-live-cd" id="id16">Rescuing using a Live CD</a></li>
<li><a class="reference internal" href="#mpt2sas" id="id17">MPT2SAS</a></li>
<li><a class="reference internal" href="#areca" id="id18">Areca</a></li>
<li><a class="reference internal" href="#vmware" id="id19">VMware</a></li>
<li><a class="reference internal" href="#qemu-kvm-xen" id="id20">QEMU/KVM/XEN</a></li>
</ul>
</div>
<div class="section" id="newer-release-available">
<h2><a class="toc-backref" href="#id1">Newer release available</a><a class="headerlink" href="#newer-release-available" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>See <a class="reference internal" href="Ubuntu 18.04 Root on ZFS.html"><span class="doc">Ubuntu 18.04 Root on ZFS</span></a> for new installs.</li>
</ul>
</div>
<div class="section" id="caution">
<h2><a class="toc-backref" href="#id2">Caution</a><a class="headerlink" href="#caution" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>This HOWTO uses a whole physical disk.</li>
<li>Do not use these instructions for dual-booting.</li>
<li>Backup your data. Any existing data will be lost.</li>
</ul>
</div>
<div class="section" id="system-requirements">
<h2><a class="toc-backref" href="#id3">System Requirements</a><a class="headerlink" href="#system-requirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://releases.ubuntu.com/16.04/ubuntu-16.04.5-desktop-amd64.iso">64-bit Ubuntu 16.04.5 (“Xenial”) Desktop
CD</a>
(<em>not</em> the server image)</li>
<li><a class="reference external" href="https://github.com/zfsonlinux/zfs/wiki/FAQ#32-bit-vs-64-bit-systems">A 64-bit kernel is strongly
encouraged.</a></li>
<li>A drive which presents 512B logical sectors. Installing on a drive
which presents 4KiB logical sectors (a “4Kn” drive) should work with
UEFI partitioning, but this has not been tested.</li>
</ul>
<p>Computers that have less than 2 GiB of memory run ZFS slowly. 4 GiB of
memory is recommended for normal performance in basic workloads. If you
wish to use deduplication, you will need <a class="reference external" href="http://wiki.freebsd.org/ZFSTuningGuide#Deduplication">massive amounts of
RAM</a>. Enabling
deduplication is a permanent change that cannot be easily reverted.</p>
<div class="section" id="support">
<h3><a class="toc-backref" href="#id4">Support</a><a class="headerlink" href="#support" title="Permalink to this headline">¶</a></h3>
<p>If you need help, reach out to the community using the <a class="reference external" href="https://github.com/zfsonlinux/zfs/wiki/Mailing-Lists">zfs-discuss
mailing list</a>
or IRC at #zfsonlinux on <a class="reference external" href="https://freenode.net/">freenode</a>. If you
have a bug report or feature request related to this HOWTO, please <a class="reference external" href="https://github.com/zfsonlinux/zfs/issues/new">file
a new issue</a> and
mention &#64;rlaager.</p>
</div>
<div class="section" id="encryption">
<h3><a class="toc-backref" href="#id5">Encryption</a><a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h3>
<p>This guide supports the three different Ubuntu encryption options:
unencrypted, LUKS (full-disk encryption), and eCryptfs (home directory
encryption).</p>
<p>Unencrypted does not encrypt anything, of course. All ZFS features are
fully available. With no encryption happening, this option naturally has
the best performance.</p>
<p>LUKS encrypts almost everything: the OS, swap, home directories, and
anything else. The only unencrypted data is the bootloader, kernel, and
initrd. The system cannot boot without the passphrase being entered at
the console. All ZFS features are fully available. Performance is good,
but LUKS sits underneath ZFS, so if multiple disks (mirror or raidz
configurations) are used, the data has to be encrypted once per disk.</p>
<p>eCryptfs protects the contents of the specified home directories. This
guide also recommends encrypted swap when using eCryptfs. Other
operating system directories, which may contain sensitive data, logs,
and/or configuration information, are not encrypted. ZFS compression is
useless on the encrypted home directories. ZFS snapshots are not
automatically and transparently mounted when using eCryptfs, and
manually mounting them requires serious knowledge of eCryptfs
administrative commands. eCryptfs sits above ZFS, so the encryption only
happens once, regardless of the number of disks in the pool. The
performance of eCryptfs may be lower than LUKS in single-disk scenarios.</p>
<p>If you want encryption, LUKS is recommended.</p>
</div>
<div class="section" id="step-1-prepare-the-install-environment">
<h3><a class="toc-backref" href="#id6">Step 1: Prepare The Install Environment</a><a class="headerlink" href="#step-1-prepare-the-install-environment" title="Permalink to this headline">¶</a></h3>
<p>1.1 Boot the Ubuntu Live CD. Select Try Ubuntu. Connect your system to
the Internet as appropriate (e.g. join your WiFi network). Open a
terminal (press Ctrl-Alt-T).</p>
<p>1.2 Setup and update the repositories:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt-add-repository universe
$ sudo apt update
</pre></div>
</div>
<p>1.3 Optional: Start the OpenSSH server in the Live CD environment:</p>
<p>If you have a second system, using SSH to access the target system can
be convenient.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ passwd
  There is no current password; hit enter at that prompt.
$ sudo apt --yes install openssh-server
</pre></div>
</div>
<p><strong>Hint:</strong> You can find your IP address with
<code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">addr</span> <span class="pre">show</span> <span class="pre">scope</span> <span class="pre">global</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">inet</span></code>. Then, from your main machine,
connect with <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">ubuntu&#64;IP</span></code>.</p>
<p>1.4 Become root:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo -i
</pre></div>
</div>
<p>1.5 Install ZFS in the Live CD environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install --yes debootstrap gdisk zfs-initramfs</span>
</pre></div>
</div>
<p><strong>Note:</strong> You can ignore the two error lines about “AppStream”. They are
harmless.</p>
</div>
<div class="section" id="step-2-disk-formatting">
<h3><a class="toc-backref" href="#id7">Step 2: Disk Formatting</a><a class="headerlink" href="#step-2-disk-formatting" title="Permalink to this headline">¶</a></h3>
<p>2.1 If you are re-using a disk, clear it as necessary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">If</span> <span class="n">the</span> <span class="n">disk</span> <span class="n">was</span> <span class="n">previously</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">MD</span> <span class="n">array</span><span class="p">,</span> <span class="n">zero</span> <span class="n">the</span> <span class="n">superblock</span><span class="p">:</span>
<span class="c1"># apt install --yes mdadm</span>
<span class="c1"># mdadm --zero-superblock --force /dev/disk/by-id/scsi-SATA_disk1</span>

<span class="n">Clear</span> <span class="n">the</span> <span class="n">partition</span> <span class="n">table</span><span class="p">:</span>
<span class="c1"># sgdisk --zap-all /dev/disk/by-id/scsi-SATA_disk1</span>
</pre></div>
</div>
<p>2.2 Partition your disk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Run</span> <span class="n">this</span> <span class="k">if</span> <span class="n">you</span> <span class="n">need</span> <span class="n">legacy</span> <span class="p">(</span><span class="n">BIOS</span><span class="p">)</span> <span class="n">booting</span><span class="p">:</span>
<span class="c1"># sgdisk -a1 -n2:34:2047  -t2:EF02 /dev/disk/by-id/scsi-SATA_disk1</span>

<span class="n">Run</span> <span class="n">this</span> <span class="k">for</span> <span class="n">UEFI</span> <span class="n">booting</span> <span class="p">(</span><span class="k">for</span> <span class="n">use</span> <span class="n">now</span> <span class="ow">or</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">future</span><span class="p">):</span>
<span class="c1"># sgdisk     -n3:1M:+512M -t3:EF00 /dev/disk/by-id/scsi-SATA_disk1</span>
</pre></div>
</div>
<p>Choose one of the following options:</p>
<p>2.2a Unencrypted or eCryptfs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># sgdisk     -n1:0:0      -t1:BF01 /dev/disk/by-id/scsi-SATA_disk1</span>
</pre></div>
</div>
<p>2.2b LUKS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># sgdisk     -n4:0:+512M  -t4:8300 /dev/disk/by-id/scsi-SATA_disk1</span>
<span class="c1"># sgdisk     -n1:0:0      -t1:8300 /dev/disk/by-id/scsi-SATA_disk1</span>
</pre></div>
</div>
<p>Always use the long <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-id/*</span></code> aliases with ZFS. Using the
<code class="docutils literal notranslate"><span class="pre">/dev/sd*</span></code> device nodes directly can cause sporadic import failures,
especially on systems that have more than one storage pool.</p>
<p><strong>Hints:</strong></p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-la</span> <span class="pre">/dev/disk/by-id</span></code> will list the aliases.</li>
<li>Are you doing this in a virtual machine? If your virtual disk is
missing from <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-id</span></code>, use <code class="docutils literal notranslate"><span class="pre">/dev/vda</span></code> if you are using
KVM with virtio; otherwise, read the
<a class="reference external" href="https://github.com/zfsonlinux/zfs/wiki/Ubuntu-16.04-Root-on-ZFS#troubleshooting">troubleshooting</a>
section.</li>
</ul>
<p>2.3 Create the root pool:</p>
<p>Choose one of the following options:</p>
<p>2.3a Unencrypted or eCryptfs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zpool create -o ashift=12 \</span>
      <span class="o">-</span><span class="n">O</span> <span class="n">atime</span><span class="o">=</span><span class="n">off</span> <span class="o">-</span><span class="n">O</span> <span class="n">canmount</span><span class="o">=</span><span class="n">off</span> <span class="o">-</span><span class="n">O</span> <span class="n">compression</span><span class="o">=</span><span class="n">lz4</span> <span class="o">-</span><span class="n">O</span> <span class="n">normalization</span><span class="o">=</span><span class="n">formD</span> \
      <span class="o">-</span><span class="n">O</span> <span class="n">mountpoint</span><span class="o">=/</span> <span class="o">-</span><span class="n">R</span> <span class="o">/</span><span class="n">mnt</span> \
      <span class="n">rpool</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk1</span><span class="o">-</span><span class="n">part1</span>
</pre></div>
</div>
<p>2.3b LUKS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksFormat -c aes-xts-plain64 -s 256 -h sha256 \</span>
      <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk1</span><span class="o">-</span><span class="n">part1</span>
<span class="c1"># cryptsetup luksOpen /dev/disk/by-id/scsi-SATA_disk1-part1 luks1</span>
<span class="c1"># zpool create -o ashift=12 \</span>
      <span class="o">-</span><span class="n">O</span> <span class="n">atime</span><span class="o">=</span><span class="n">off</span> <span class="o">-</span><span class="n">O</span> <span class="n">canmount</span><span class="o">=</span><span class="n">off</span> <span class="o">-</span><span class="n">O</span> <span class="n">compression</span><span class="o">=</span><span class="n">lz4</span> <span class="o">-</span><span class="n">O</span> <span class="n">normalization</span><span class="o">=</span><span class="n">formD</span> \
      <span class="o">-</span><span class="n">O</span> <span class="n">mountpoint</span><span class="o">=/</span> <span class="o">-</span><span class="n">R</span> <span class="o">/</span><span class="n">mnt</span> \
      <span class="n">rpool</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">luks1</span>
</pre></div>
</div>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li>The use of <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is recommended here because many drives
today have 4KiB (or larger) physical sectors, even though they
present 512B logical sectors. Also, a future replacement drive may
have 4KiB physical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is desirable)
or 4KiB logical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is required).</li>
<li>Setting <code class="docutils literal notranslate"><span class="pre">normalization=formD</span></code> eliminates some corner cases relating
to UTF-8 filename normalization. It also implies <code class="docutils literal notranslate"><span class="pre">utf8only=on</span></code>,
which means that only UTF-8 filenames are allowed. If you care to
support non-UTF-8 filenames, do not use this option. For a discussion
of why requiring UTF-8 filenames may be a bad idea, see <a class="reference external" href="http://utcc.utoronto.ca/~cks/space/blog/linux/ForcedUTF8Filenames">The problems
with enforced UTF-8 only
filenames</a>.</li>
<li>Make sure to include the <code class="docutils literal notranslate"><span class="pre">-part1</span></code> portion of the drive path. If you
forget that, you are specifying the whole disk, which ZFS will then
re-partition, and you will lose the bootloader partition(s).</li>
<li>For LUKS, the key size chosen is 256 bits. However, XTS mode requires
two keys, so the LUKS key is split in half. Thus, <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">256</span></code> means
AES-128, which is the LUKS and Ubuntu default.</li>
<li>Your passphrase will likely be the weakest link. Choose wisely. See
<a class="reference external" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#5-security-aspects">section 5 of the cryptsetup
FAQ</a>
for guidance.</li>
</ul>
<p><strong>Hints:</strong></p>
<ul class="simple">
<li>The root pool does not have to be a single disk; it can have a mirror
or raidz topology. In that case, repeat the partitioning commands for
all the disks which will be part of the pool. Then, create the pool
using
<code class="docutils literal notranslate"><span class="pre">zpool</span> <span class="pre">create</span> <span class="pre">...</span> <span class="pre">rpool</span> <span class="pre">mirror</span> <span class="pre">/dev/disk/by-id/scsi-SATA_disk1-part1</span> <span class="pre">/dev/disk/by-id/scsi-SATA_disk2-part1</span></code>
(or replace <code class="docutils literal notranslate"><span class="pre">mirror</span></code> with <code class="docutils literal notranslate"><span class="pre">raidz</span></code>, <code class="docutils literal notranslate"><span class="pre">raidz2</span></code>, or <code class="docutils literal notranslate"><span class="pre">raidz3</span></code> and
list the partitions from additional disks).</li>
<li>The pool name is arbitrary. On systems that can automatically install
to ZFS, the root pool is named <code class="docutils literal notranslate"><span class="pre">rpool</span></code> by default. If you work with
multiple systems, it might be wise to use <code class="docutils literal notranslate"><span class="pre">hostname</span></code>,
<code class="docutils literal notranslate"><span class="pre">hostname0</span></code>, or <code class="docutils literal notranslate"><span class="pre">hostname-1</span></code> instead.</li>
</ul>
</div>
<div class="section" id="step-3-system-installation">
<h3><a class="toc-backref" href="#id8">Step 3: System Installation</a><a class="headerlink" href="#step-3-system-installation" title="Permalink to this headline">¶</a></h3>
<p>3.1 Create a filesystem dataset to act as a container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zfs create -o canmount=off -o mountpoint=none rpool/ROOT</span>
</pre></div>
</div>
<p>On Solaris systems, the root filesystem is cloned and the suffix is
incremented for major system changes through <code class="docutils literal notranslate"><span class="pre">pkg</span> <span class="pre">image-update</span></code> or
<code class="docutils literal notranslate"><span class="pre">beadm</span></code>. Similar functionality for APT is possible but currently
unimplemented. Even without such a tool, it can still be used for
manually created clones.</p>
<p>3.2 Create a filesystem dataset for the root filesystem of the Ubuntu
system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zfs create -o canmount=noauto -o mountpoint=/ rpool/ROOT/ubuntu</span>
<span class="c1"># zfs mount rpool/ROOT/ubuntu</span>
</pre></div>
</div>
<p>With ZFS, it is not normally necessary to use a mount command (either
<code class="docutils literal notranslate"><span class="pre">mount</span></code> or <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">mount</span></code>). This situation is an exception because of
<code class="docutils literal notranslate"><span class="pre">canmount=noauto</span></code>.</p>
<p>3.3 Create datasets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zfs create                 -o setuid=off              rpool/home</span>
<span class="c1"># zfs create -o mountpoint=/root                        rpool/home/root</span>
<span class="c1"># zfs create -o canmount=off -o setuid=off  -o exec=off rpool/var</span>
<span class="c1"># zfs create -o com.sun:auto-snapshot=false             rpool/var/cache</span>
<span class="c1"># zfs create                                            rpool/var/log</span>
<span class="c1"># zfs create                                            rpool/var/spool</span>
<span class="c1"># zfs create -o com.sun:auto-snapshot=false -o exec=on  rpool/var/tmp</span>

<span class="n">If</span> <span class="n">you</span> <span class="n">use</span> <span class="o">/</span><span class="n">srv</span> <span class="n">on</span> <span class="n">this</span> <span class="n">system</span><span class="p">:</span>
<span class="c1"># zfs create                                            rpool/srv</span>

<span class="n">If</span> <span class="n">this</span> <span class="n">system</span> <span class="n">will</span> <span class="n">have</span> <span class="n">games</span> <span class="n">installed</span><span class="p">:</span>
<span class="c1"># zfs create                                            rpool/var/games</span>

<span class="n">If</span> <span class="n">this</span> <span class="n">system</span> <span class="n">will</span> <span class="n">store</span> <span class="n">local</span> <span class="n">email</span> <span class="ow">in</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">mail</span><span class="p">:</span>
<span class="c1"># zfs create                                            rpool/var/mail</span>

<span class="n">If</span> <span class="n">this</span> <span class="n">system</span> <span class="n">will</span> <span class="n">use</span> <span class="n">NFS</span> <span class="p">(</span><span class="n">locking</span><span class="p">):</span>
<span class="c1"># zfs create -o com.sun:auto-snapshot=false \</span>
             <span class="o">-</span><span class="n">o</span> <span class="n">mountpoint</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nfs</span>                 <span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">nfs</span>
</pre></div>
</div>
<p>The primary goal of this dataset layout is to separate the OS from user
data. This allows the root filesystem to be rolled back without rolling
back user data such as logs (in <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>). This will be especially
important if/when a <code class="docutils literal notranslate"><span class="pre">beadm</span></code> or similar utility is integrated. Since we
are creating multiple datasets anyway, it is trivial to add some
restrictions (for extra security) at the same time. The
<code class="docutils literal notranslate"><span class="pre">com.sun.auto-snapshot</span></code> setting is used by some ZFS snapshot utilities
to exclude transient data.</p>
<p>3.4 For LUKS installs only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mke2fs -t ext2 /dev/disk/by-id/scsi-SATA_disk1-part4</span>
<span class="c1"># mkdir /mnt/boot</span>
<span class="c1"># mount /dev/disk/by-id/scsi-SATA_disk1-part4 /mnt/boot</span>
</pre></div>
</div>
<p>3.5 Install the minimal system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># chmod 1777 /mnt/var/tmp</span>
<span class="c1"># debootstrap xenial /mnt</span>
<span class="c1"># zfs set devices=off rpool</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">debootstrap</span></code> command leaves the new system in an unconfigured
state. An alternative to using <code class="docutils literal notranslate"><span class="pre">debootstrap</span></code> is to copy the entirety
of a working system into the new ZFS root.</p>
</div>
<div class="section" id="step-4-system-configuration">
<h3><a class="toc-backref" href="#id9">Step 4: System Configuration</a><a class="headerlink" href="#step-4-system-configuration" title="Permalink to this headline">¶</a></h3>
<p>4.1 Configure the hostname (change <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> to the desired
hostname).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># echo HOSTNAME &gt; /mnt/etc/hostname</span>

<span class="c1"># vi /mnt/etc/hosts</span>
<span class="n">Add</span> <span class="n">a</span> <span class="n">line</span><span class="p">:</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">1.1</span>       <span class="n">HOSTNAME</span>
<span class="ow">or</span> <span class="k">if</span> <span class="n">the</span> <span class="n">system</span> <span class="n">has</span> <span class="n">a</span> <span class="n">real</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">DNS</span><span class="p">:</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">1.1</span>       <span class="n">FQDN</span> <span class="n">HOSTNAME</span>
</pre></div>
</div>
<p><strong>Hint:</strong> Use <code class="docutils literal notranslate"><span class="pre">nano</span></code> if you find <code class="docutils literal notranslate"><span class="pre">vi</span></code> confusing.</p>
<p>4.2 Configure the network interface:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Find</span> <span class="n">the</span> <span class="n">interface</span> <span class="n">name</span><span class="p">:</span>
<span class="c1"># ip addr show</span>

<span class="c1"># vi /mnt/etc/network/interfaces.d/NAME</span>
<span class="n">auto</span> <span class="n">NAME</span>
<span class="n">iface</span> <span class="n">NAME</span> <span class="n">inet</span> <span class="n">dhcp</span>
</pre></div>
</div>
<p>Customize this file if the system is not a DHCP client.</p>
<p>4.3 Configure the package sources:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># vi /mnt/etc/apt/sources.list</span>
<span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">archive</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">xenial</span> <span class="n">main</span> <span class="n">universe</span>
<span class="n">deb</span><span class="o">-</span><span class="n">src</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">archive</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">xenial</span> <span class="n">main</span> <span class="n">universe</span>

<span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">security</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">xenial</span><span class="o">-</span><span class="n">security</span> <span class="n">main</span> <span class="n">universe</span>
<span class="n">deb</span><span class="o">-</span><span class="n">src</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">security</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">xenial</span><span class="o">-</span><span class="n">security</span> <span class="n">main</span> <span class="n">universe</span>

<span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">archive</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">xenial</span><span class="o">-</span><span class="n">updates</span> <span class="n">main</span> <span class="n">universe</span>
<span class="n">deb</span><span class="o">-</span><span class="n">src</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">archive</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">xenial</span><span class="o">-</span><span class="n">updates</span> <span class="n">main</span> <span class="n">universe</span>
</pre></div>
</div>
<p>4.4 Bind the virtual filesystems from the LiveCD environment to the new
system and <code class="docutils literal notranslate"><span class="pre">chroot</span></code> into it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mount --rbind /dev  /mnt/dev</span>
<span class="c1"># mount --rbind /proc /mnt/proc</span>
<span class="c1"># mount --rbind /sys  /mnt/sys</span>
<span class="c1"># chroot /mnt /bin/bash --login</span>
</pre></div>
</div>
<p><strong>Note:</strong> This is using <code class="docutils literal notranslate"><span class="pre">--rbind</span></code>, not <code class="docutils literal notranslate"><span class="pre">--bind</span></code>.</p>
<p>4.5 Configure a basic system environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># locale-gen en_US.UTF-8</span>
</pre></div>
</div>
<p>Even if you prefer a non-English system language, always ensure that
<code class="docutils literal notranslate"><span class="pre">en_US.UTF-8</span></code> is available.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># echo LANG=en_US.UTF-8 &gt; /etc/default/locale</span>

<span class="c1"># dpkg-reconfigure tzdata</span>

<span class="c1"># ln -s /proc/self/mounts /etc/mtab</span>
<span class="c1"># apt update</span>
<span class="c1"># apt install --yes ubuntu-minimal</span>

<span class="n">If</span> <span class="n">you</span> <span class="n">prefer</span> <span class="n">nano</span> <span class="n">over</span> <span class="n">vi</span><span class="p">,</span> <span class="n">install</span> <span class="n">it</span><span class="p">:</span>
<span class="c1"># apt install --yes nano</span>
</pre></div>
</div>
<p>4.6 Install ZFS in the chroot environment for the new system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install --yes --no-install-recommends linux-image-generic</span>
<span class="c1"># apt install --yes zfs-initramfs</span>
</pre></div>
</div>
<p>4.7 For LUKS installs only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># echo UUID=$(blkid -s UUID -o value \</span>
      <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk1</span><span class="o">-</span><span class="n">part4</span><span class="p">)</span> \
      <span class="o">/</span><span class="n">boot</span> <span class="n">ext2</span> <span class="n">defaults</span> <span class="mi">0</span> <span class="mi">2</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>

<span class="c1"># apt install --yes cryptsetup</span>

<span class="c1"># echo luks1 UUID=$(blkid -s UUID -o value \</span>
      <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk1</span><span class="o">-</span><span class="n">part1</span><span class="p">)</span> <span class="n">none</span> \
      <span class="n">luks</span><span class="p">,</span><span class="n">discard</span><span class="p">,</span><span class="n">initramfs</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">crypttab</span>

<span class="c1"># vi /etc/udev/rules.d/99-local-crypt.rules</span>
<span class="n">ENV</span><span class="p">{</span><span class="n">DM_NAME</span><span class="p">}</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">SYMLINK</span><span class="o">+=</span><span class="s2">&quot;$env</span><span class="si">{DM_NAME}</span><span class="s2">&quot;</span>
<span class="n">ENV</span><span class="p">{</span><span class="n">DM_NAME</span><span class="p">}</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">SYMLINK</span><span class="o">+=</span><span class="s2">&quot;dm-name-$env</span><span class="si">{DM_NAME}</span><span class="s2">&quot;</span>

<span class="c1"># ln -s /dev/mapper/luks1 /dev/luks1</span>
</pre></div>
</div>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li>The use of <code class="docutils literal notranslate"><span class="pre">initramfs</span></code> is a work-around for <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/cryptsetup/+bug/1612906">cryptsetup does not
support
ZFS</a>.</li>
<li>The 99-local-crypt.rules file and symlink in /dev are a work-around
for <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/grub2/+bug/1527727">grub-probe assuming all devices are in
/dev</a>.</li>
</ul>
<p>4.8 Install GRUB</p>
<p>Choose one of the following options:</p>
<p>4.8a Install GRUB for legacy (MBR) booting</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install --yes grub-pc</span>
</pre></div>
</div>
<p>Install GRUB to the disk(s), not the partition(s).</p>
<p>4.8b Install GRUB for UEFI booting</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install dosfstools</span>
<span class="c1"># mkdosfs -F 32 -n EFI /dev/disk/by-id/scsi-SATA_disk1-part3</span>
<span class="c1"># mkdir /boot/efi</span>
<span class="c1"># echo PARTUUID=$(blkid -s PARTUUID -o value \</span>
      <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk1</span><span class="o">-</span><span class="n">part3</span><span class="p">)</span> \
      <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">efi</span> <span class="n">vfat</span> <span class="n">nofail</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="n">systemd</span><span class="o">.</span><span class="n">device</span><span class="o">-</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
<span class="c1"># mount /boot/efi</span>
<span class="c1"># apt install --yes grub-efi-amd64</span>
</pre></div>
</div>
<p>4.9 Setup system groups:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># addgroup --system lpadmin</span>
<span class="c1"># addgroup --system sambashare</span>
</pre></div>
</div>
<p>4.10 Set a root password</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># passwd</span>
</pre></div>
</div>
<p>4.11 Fix filesystem mount ordering</p>
<p><a class="reference external" href="https://github.com/zfsonlinux/zfs/issues/4898">Until ZFS gains a systemd mount
generator</a>, there are
races between mounting filesystems and starting certain daemons. In
practice, the issues (e.g.
<a class="reference external" href="https://github.com/zfsonlinux/zfs/issues/5754">#5754</a>) seem to be
with certain filesystems in <code class="docutils literal notranslate"><span class="pre">/var</span></code>, specifically <code class="docutils literal notranslate"><span class="pre">/var/log</span></code> and
<code class="docutils literal notranslate"><span class="pre">/var/tmp</span></code>. Setting these to use <code class="docutils literal notranslate"><span class="pre">legacy</span></code> mounting, and listing them
in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> makes systemd aware that these are separate
mountpoints. In turn, <code class="docutils literal notranslate"><span class="pre">rsyslog.service</span></code> depends on <code class="docutils literal notranslate"><span class="pre">var-log.mount</span></code>
by way of <code class="docutils literal notranslate"><span class="pre">local-fs.target</span></code> and services using the <code class="docutils literal notranslate"><span class="pre">PrivateTmp</span></code>
feature of systemd automatically use <code class="docutils literal notranslate"><span class="pre">After=var-tmp.mount</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zfs set mountpoint=legacy rpool/var/log</span>
<span class="c1"># zfs set mountpoint=legacy rpool/var/tmp</span>
<span class="c1"># cat &gt;&gt; /etc/fstab &lt;&lt; EOF</span>
<span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span> <span class="n">zfs</span> <span class="n">defaults</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">rpool</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span> <span class="n">zfs</span> <span class="n">defaults</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">EOF</span>
</pre></div>
</div>
</div>
<div class="section" id="step-5-grub-installation">
<h3><a class="toc-backref" href="#id10">Step 5: GRUB Installation</a><a class="headerlink" href="#step-5-grub-installation" title="Permalink to this headline">¶</a></h3>
<p>5.1 Verify that the ZFS root filesystem is recognized:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># grub-probe /</span>
<span class="n">zfs</span>
</pre></div>
</div>
<p><strong>Note:</strong> GRUB uses <code class="docutils literal notranslate"><span class="pre">zpool</span> <span class="pre">status</span></code> in order to determine the location
of devices. <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/grub2/+bug/1527727">grub-probe assumes all devices are in
/dev</a>.
The <code class="docutils literal notranslate"><span class="pre">zfs-initramfs</span></code> package <a class="reference external" href="https://packages.ubuntu.com/xenial-updates/all/zfs-initramfs/filelist">ships udev rules that create
symlinks</a>
to <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/zfs-initramfs/+bug/1530953">work around the
problem</a>,
but <a class="reference external" href="https://github.com/zfsonlinux/grub/issues/5#issuecomment-249427634">there have still been reports of
problems</a>.
If this happens, you will get an error saying
<code class="docutils literal notranslate"><span class="pre">grub-probe:</span> <span class="pre">error:</span> <span class="pre">failed</span> <span class="pre">to</span> <span class="pre">get</span> <span class="pre">canonical</span> <span class="pre">path</span></code> and should run the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># export ZPOOL_VDEV_NAME_PATH=YES</span>
</pre></div>
</div>
<p>5.2 Refresh the initrd files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># update-initramfs -c -k all</span>
<span class="n">update</span><span class="o">-</span><span class="n">initramfs</span><span class="p">:</span> <span class="n">Generating</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="n">generic</span>
</pre></div>
</div>
<p><strong>Note:</strong> When using LUKS, this will print “WARNING could not determine
root device from /etc/fstab”. This is because <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/cryptsetup/+bug/1612906">cryptsetup does not
support
ZFS</a>.</p>
<p>5.3 Optional (but highly recommended): Make debugging GRUB easier:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># vi /etc/default/grub</span>
<span class="n">Comment</span> <span class="n">out</span><span class="p">:</span> <span class="n">GRUB_HIDDEN_TIMEOUT</span><span class="o">=</span><span class="mi">0</span>
<span class="n">Remove</span> <span class="n">quiet</span> <span class="ow">and</span> <span class="n">splash</span> <span class="n">from</span><span class="p">:</span> <span class="n">GRUB_CMDLINE_LINUX_DEFAULT</span>
<span class="n">Uncomment</span><span class="p">:</span> <span class="n">GRUB_TERMINAL</span><span class="o">=</span><span class="n">console</span>
<span class="n">Save</span> <span class="ow">and</span> <span class="n">quit</span><span class="o">.</span>
</pre></div>
</div>
<p>Later, once the system has rebooted twice and you are sure everything is
working, you can undo these changes, if desired.</p>
<p>5.4 Update the boot configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># update-grub</span>
<span class="n">Generating</span> <span class="n">grub</span> <span class="n">configuration</span> <span class="n">file</span> <span class="o">...</span>
<span class="n">Found</span> <span class="n">linux</span> <span class="n">image</span><span class="p">:</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="n">generic</span>
<span class="n">Found</span> <span class="n">initrd</span> <span class="n">image</span><span class="p">:</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="n">generic</span>
<span class="n">done</span>
</pre></div>
</div>
<p>5.5 Install the boot loader</p>
<p>5.5a For legacy (MBR) booting, install GRUB to the MBR:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># grub-install /dev/disk/by-id/scsi-SATA_disk1</span>
<span class="n">Installing</span> <span class="k">for</span> <span class="n">i386</span><span class="o">-</span><span class="n">pc</span> <span class="n">platform</span><span class="o">.</span>
<span class="n">Installation</span> <span class="n">finished</span><span class="o">.</span> <span class="n">No</span> <span class="n">error</span> <span class="n">reported</span><span class="o">.</span>
</pre></div>
</div>
<p>Do not reboot the computer until you get exactly that result message.
Note that you are installing GRUB to the whole disk, not a partition.</p>
<p>If you are creating a mirror, repeat the grub-install command for each
disk in the pool.</p>
<p>5.5b For UEFI booting, install GRUB:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># grub-install --target=x86_64-efi --efi-directory=/boot/efi \</span>
      <span class="o">--</span><span class="n">bootloader</span><span class="o">-</span><span class="nb">id</span><span class="o">=</span><span class="n">ubuntu</span> <span class="o">--</span><span class="n">recheck</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">floppy</span>
</pre></div>
</div>
<p>5.6 Verify that the ZFS module is installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ls /boot/grub/*/zfs.mod</span>
</pre></div>
</div>
</div>
<div class="section" id="step-6-first-boot">
<h3><a class="toc-backref" href="#id11">Step 6: First Boot</a><a class="headerlink" href="#step-6-first-boot" title="Permalink to this headline">¶</a></h3>
<p>6.1 Snapshot the initial installation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zfs snapshot rpool/ROOT/ubuntu@install</span>
</pre></div>
</div>
<p>In the future, you will likely want to take snapshots before each
upgrade, and remove old snapshots (including this one) at some point to
save space.</p>
<p>6.2 Exit from the <code class="docutils literal notranslate"><span class="pre">chroot</span></code> environment back to the LiveCD environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># exit</span>
</pre></div>
</div>
<p>6.3 Run these commands in the LiveCD environment to unmount all
filesystems:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mount | grep -v zfs | tac | awk &#39;/\/mnt/ {print $3}&#39; | xargs -i{} umount -lf {}</span>
<span class="c1"># zpool export rpool</span>
</pre></div>
</div>
<p>6.4 Reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># reboot</span>
</pre></div>
</div>
<p>6.5 Wait for the newly installed system to boot normally. Login as root.</p>
<p>6.6 Create a user account:</p>
<p>Choose one of the following options:</p>
<p>6.6a Unencrypted or LUKS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zfs create rpool/home/YOURUSERNAME</span>
<span class="c1"># adduser YOURUSERNAME</span>
<span class="c1"># cp -a /etc/skel/.[!.]* /home/YOURUSERNAME</span>
<span class="c1"># chown -R YOURUSERNAME:YOURUSERNAME /home/YOURUSERNAME</span>
</pre></div>
</div>
<p>6.6b eCryptfs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install ecryptfs-utils</span>

<span class="c1"># zfs create -o compression=off -o mountpoint=/home/.ecryptfs/YOURUSERNAME \</span>
      <span class="n">rpool</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">temp</span><span class="o">-</span><span class="n">YOURUSERNAME</span>
<span class="c1"># adduser --encrypt-home YOURUSERNAME</span>
<span class="c1"># zfs rename rpool/home/temp-YOURUSERNAME rpool/home/YOURUSERNAME</span>
</pre></div>
</div>
<p>The temporary name for the dataset is required to work-around <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/ecryptfs-utils/+bug/1574174">a bug in
ecryptfs-setup-private</a>.
Otherwise, it will fail with an error saying the home directory is
already mounted; that check is not specific enough in the pattern it
uses.</p>
<p><strong>Note:</strong> Automatically mounted snapshots (i.e. the <code class="docutils literal notranslate"><span class="pre">.zfs/snapshots</span></code>
directory) will not work through eCryptfs. You can do another eCryptfs
mount manually if you need to access files in a snapshot. A script to
automate the mounting should be possible, but has not yet been
implemented.</p>
<p>6.7 Add your user account to the default set of groups for an
administrator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># usermod -a -G adm,cdrom,dip,lpadmin,plugdev,sambashare,sudo YOURUSERNAME</span>
</pre></div>
</div>
<p>6.8 Mirror GRUB</p>
<p>If you installed to multiple disks, install GRUB on the additional
disks:</p>
<p>6.8a For legacy (MBR) booting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dpkg-reconfigure grub-pc</span>
<span class="n">Hit</span> <span class="n">enter</span> <span class="n">until</span> <span class="n">you</span> <span class="n">get</span> <span class="n">to</span> <span class="n">the</span> <span class="n">device</span> <span class="n">selection</span> <span class="n">screen</span><span class="o">.</span>
<span class="n">Select</span> <span class="p">(</span><span class="n">using</span> <span class="n">the</span> <span class="n">space</span> <span class="n">bar</span><span class="p">)</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">disks</span> <span class="p">(</span><span class="ow">not</span> <span class="n">partitions</span><span class="p">)</span> <span class="ow">in</span> <span class="n">your</span> <span class="n">pool</span><span class="o">.</span>
</pre></div>
</div>
<p>6.8b UEFI</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># umount /boot/efi</span>

<span class="n">For</span> <span class="n">the</span> <span class="n">second</span> <span class="ow">and</span> <span class="n">subsequent</span> <span class="n">disks</span> <span class="p">(</span><span class="n">increment</span> <span class="n">ubuntu</span><span class="o">-</span><span class="mi">2</span> <span class="n">to</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">):</span>
<span class="c1"># dd if=/dev/disk/by-id/scsi-SATA_disk1-part3 \</span>
     <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="n">SATA_disk2</span><span class="o">-</span><span class="n">part3</span>
<span class="c1"># efibootmgr -c -g -d /dev/disk/by-id/scsi-SATA_disk2 \</span>
      <span class="o">-</span><span class="n">p</span> <span class="mi">3</span> <span class="o">-</span><span class="n">L</span> <span class="s2">&quot;ubuntu-2&quot;</span> <span class="o">-</span><span class="n">l</span> <span class="s1">&#39;\EFI\Ubuntu\grubx64.efi&#39;</span>

<span class="c1"># mount /boot/efi</span>
</pre></div>
</div>
</div>
<div class="section" id="step-7-configure-swap">
<h3><a class="toc-backref" href="#id12">Step 7: Configure Swap</a><a class="headerlink" href="#step-7-configure-swap" title="Permalink to this headline">¶</a></h3>
<p>7.1 Create a volume dataset (zvol) for use as a swap device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zfs create -V 4G -b $(getconf PAGESIZE) -o compression=zle \</span>
      <span class="o">-</span><span class="n">o</span> <span class="n">logbias</span><span class="o">=</span><span class="n">throughput</span> <span class="o">-</span><span class="n">o</span> <span class="n">sync</span><span class="o">=</span><span class="n">always</span> \
      <span class="o">-</span><span class="n">o</span> <span class="n">primarycache</span><span class="o">=</span><span class="n">metadata</span> <span class="o">-</span><span class="n">o</span> <span class="n">secondarycache</span><span class="o">=</span><span class="n">none</span> \
      <span class="o">-</span><span class="n">o</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="p">:</span><span class="n">auto</span><span class="o">-</span><span class="n">snapshot</span><span class="o">=</span><span class="n">false</span> <span class="n">rpool</span><span class="o">/</span><span class="n">swap</span>
</pre></div>
</div>
<p>You can adjust the size (the <code class="docutils literal notranslate"><span class="pre">4G</span></code> part) to your needs.</p>
<p>The compression algorithm is set to <code class="docutils literal notranslate"><span class="pre">zle</span></code> because it is the cheapest
available algorithm. As this guide recommends <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> (4 kiB
blocks on disk), the common case of a 4 kiB page size means that no
compression algorithm can reduce I/O. The exception is all-zero pages,
which are dropped by ZFS; but some form of compression has to be enabled
to get this behavior.</p>
<p>7.2 Configure the swap device:</p>
<p>Choose one of the following options:</p>
<p>7.2a Unencrypted or LUKS:</p>
<p><strong>Caution</strong>: Always use long <code class="docutils literal notranslate"><span class="pre">/dev/zvol</span></code> aliases in configuration
files. Never use a short <code class="docutils literal notranslate"><span class="pre">/dev/zdX</span></code> device name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkswap -f /dev/zvol/rpool/swap</span>
<span class="c1"># echo /dev/zvol/rpool/swap none swap defaults 0 0 &gt;&gt; /etc/fstab</span>
</pre></div>
</div>
<p>7.2b eCryptfs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install cryptsetup</span>
<span class="c1"># echo cryptswap1 /dev/zvol/rpool/swap /dev/urandom \</span>
      <span class="n">swap</span><span class="p">,</span><span class="n">cipher</span><span class="o">=</span><span class="n">aes</span><span class="o">-</span><span class="n">xts</span><span class="o">-</span><span class="n">plain64</span><span class="p">:</span><span class="n">sha256</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">256</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">crypttab</span>
<span class="c1"># systemctl daemon-reload</span>
<span class="c1"># systemctl start systemd-cryptsetup@cryptswap1.service</span>
<span class="c1"># echo /dev/mapper/cryptswap1 none swap defaults 0 0 &gt;&gt; /etc/fstab</span>
</pre></div>
</div>
<p>7.3 Enable the swap device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># swapon -av</span>
</pre></div>
</div>
</div>
<div class="section" id="step-8-full-software-installation">
<h3><a class="toc-backref" href="#id13">Step 8: Full Software Installation</a><a class="headerlink" href="#step-8-full-software-installation" title="Permalink to this headline">¶</a></h3>
<p>8.1 Upgrade the minimal system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt dist-upgrade --yes</span>
</pre></div>
</div>
<p>8.2 Install a regular set of software:</p>
<p>Choose one of the following options:</p>
<p>8.2a Install a command-line environment only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install --yes ubuntu-standard</span>
</pre></div>
</div>
<p>8.2b Install a full GUI environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install --yes ubuntu-desktop</span>
</pre></div>
</div>
<p><strong>Hint</strong>: If you are installing a full GUI environment, you will likely
want to manage your network with NetworkManager. In that case,
<code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">/etc/network/interfaces.d/eth0</span></code>.</p>
<p>8.3 Optional: Disable log compression:</p>
<p>As <code class="docutils literal notranslate"><span class="pre">/var/log</span></code> is already compressed by ZFS, logrotate’s compression is
going to burn CPU and disk I/O for (in most cases) very little gain.
Also, if you are making snapshots of <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, logrotate’s
compression will actually waste space, as the uncompressed data will
live on in the snapshot. You can edit the files in <code class="docutils literal notranslate"><span class="pre">/etc/logrotate.d</span></code>
by hand to comment out <code class="docutils literal notranslate"><span class="pre">compress</span></code>, or use this loop (copy-and-paste
highly recommended):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># for file in /etc/logrotate.d/* ; do</span>
    <span class="k">if</span> <span class="n">grep</span> <span class="o">-</span><span class="n">Eq</span> <span class="s2">&quot;(^|[^#y])compress&quot;</span> <span class="s2">&quot;$file&quot;</span> <span class="p">;</span> <span class="n">then</span>
        <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;s/(^|[^#y])(compress)/</span><span class="se">\1</span><span class="s2">#</span><span class="se">\2</span><span class="s2">/&quot;</span> <span class="s2">&quot;$file&quot;</span>
    <span class="n">fi</span>
<span class="n">done</span>
</pre></div>
</div>
<p>8.4 Reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># reboot</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-9-final-cleanup">
<h2><a class="toc-backref" href="#id14">Step 9: Final Cleanup</a><a class="headerlink" href="#step-9-final-cleanup" title="Permalink to this headline">¶</a></h2>
<p>9.1 Wait for the system to boot normally. Login using the account you
created. Ensure the system (including networking) works normally.</p>
<p>9.2 Optional: Delete the snapshot of the initial installation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo zfs destroy rpool/ROOT/ubuntu@install
</pre></div>
</div>
<p>9.3 Optional: Disable the root password</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo usermod -p &#39;*&#39; root
</pre></div>
</div>
<p>9.4 Optional:</p>
<p>If you prefer the graphical boot process, you can re-enable it now. If
you are using LUKS, it makes the prompt look nicer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo vi /etc/default/grub
Uncomment GRUB_HIDDEN_TIMEOUT=0
Add quiet and splash to GRUB_CMDLINE_LINUX_DEFAULT
Comment out GRUB_TERMINAL=console
Save and quit.

$ sudo update-grub
</pre></div>
</div>
<div class="section" id="troubleshooting">
<h3><a class="toc-backref" href="#id15">Troubleshooting</a><a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="rescuing-using-a-live-cd">
<h2><a class="toc-backref" href="#id16">Rescuing using a Live CD</a><a class="headerlink" href="#rescuing-using-a-live-cd" title="Permalink to this headline">¶</a></h2>
<p>Boot the Live CD and open a terminal.</p>
<p>Become root and install the ZFS utilities:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo -i
# apt update
# apt install --yes zfsutils-linux
</pre></div>
</div>
<p>This will automatically import your pool. Export it and re-import it to
get the mounts right:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zpool export -a</span>
<span class="c1"># zpool import -N -R /mnt rpool</span>
<span class="c1"># zfs mount rpool/ROOT/ubuntu</span>
<span class="c1"># zfs mount -a</span>
</pre></div>
</div>
<p>If needed, you can chroot into your installed environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mount --rbind /dev  /mnt/dev</span>
<span class="c1"># mount --rbind /proc /mnt/proc</span>
<span class="c1"># mount --rbind /sys  /mnt/sys</span>
<span class="c1"># chroot /mnt /bin/bash --login</span>
</pre></div>
</div>
<p>Do whatever you need to do to fix your system.</p>
<p>When done, cleanup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mount | grep -v zfs | tac | awk &#39;/\/mnt/ {print $3}&#39; | xargs -i{} umount -lf {}</span>
<span class="c1"># zpool export rpool</span>
<span class="c1"># reboot</span>
</pre></div>
</div>
</div>
<div class="section" id="mpt2sas">
<h2><a class="toc-backref" href="#id17">MPT2SAS</a><a class="headerlink" href="#mpt2sas" title="Permalink to this headline">¶</a></h2>
<p>Most problem reports for this tutorial involve <code class="docutils literal notranslate"><span class="pre">mpt2sas</span></code> hardware that
does slow asynchronous drive initialization, like some IBM M1015 or
OEM-branded cards that have been flashed to the reference LSI firmware.</p>
<p>The basic problem is that disks on these controllers are not visible to
the Linux kernel until after the regular system is started, and ZoL does
not hotplug pool members. See
<a class="reference external" href="https://github.com/zfsonlinux/zfs/issues/330">https://github.com/zfsonlinux/zfs/issues/330</a>.</p>
<p>Most LSI cards are perfectly compatible with ZoL. If your card has this
glitch, try setting rootdelay=X in GRUB_CMDLINE_LINUX. The system will
wait up to X seconds for all drives to appear before importing the pool.</p>
</div>
<div class="section" id="areca">
<h2><a class="toc-backref" href="#id18">Areca</a><a class="headerlink" href="#areca" title="Permalink to this headline">¶</a></h2>
<p>Systems that require the <code class="docutils literal notranslate"><span class="pre">arcsas</span></code> blob driver should add it to the
<code class="docutils literal notranslate"><span class="pre">/etc/initramfs-tools/modules</span></code> file and run
<code class="docutils literal notranslate"><span class="pre">update-initramfs</span> <span class="pre">-c</span> <span class="pre">-k</span> <span class="pre">all</span></code>.</p>
<p>Upgrade or downgrade the Areca driver if something like
<code class="docutils literal notranslate"><span class="pre">RIP:</span> <span class="pre">0010:[&lt;ffffffff8101b316&gt;]</span>&#160; <span class="pre">[&lt;ffffffff8101b316&gt;]</span> <span class="pre">native_read_tsc+0x6/0x20</span></code>
appears anywhere in kernel log. ZoL is unstable on systems that emit
this error message.</p>
</div>
<div class="section" id="vmware">
<h2><a class="toc-backref" href="#id19">VMware</a><a class="headerlink" href="#vmware" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Set <code class="docutils literal notranslate"><span class="pre">disk.EnableUUID</span> <span class="pre">=</span> <span class="pre">&quot;TRUE&quot;</span></code> in the vmx file or vsphere
configuration. Doing this ensures that <code class="docutils literal notranslate"><span class="pre">/dev/disk</span></code> aliases are
created in the guest.</li>
</ul>
</div>
<div class="section" id="qemu-kvm-xen">
<h2><a class="toc-backref" href="#id20">QEMU/KVM/XEN</a><a class="headerlink" href="#qemu-kvm-xen" title="Permalink to this headline">¶</a></h2>
<p>Set a unique serial number on each virtual disk using libvirt or qemu
(e.g. <code class="docutils literal notranslate"><span class="pre">-drive</span> <span class="pre">if=none,id=disk1,file=disk1.qcow2,serial=1234567890</span></code>).</p>
<p>To be able to use UEFI in guests (instead of only BIOS booting), run
this on the host:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt install ovmf
$ sudo vi /etc/libvirt/qemu.conf
Uncomment these lines:
nvram = [
   &quot;/usr/share/OVMF/OVMF_CODE.fd:/usr/share/OVMF/OVMF_VARS.fd&quot;,
   &quot;/usr/share/AAVMF/AAVMF_CODE.fd:/usr/share/AAVMF/AAVMF_VARS.fd&quot;
]
$ sudo service libvirt-bin restart
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static//img/320px-Open-ZFS-Secondary-Logo-Colour-halfsize.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference external" href="https://wiki.archlinux.org/index.php/ZFS">ArchLinux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Debian/index.html">Debian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fedora.html">Fedora</a></li>
<li class="toctree-l2"><a class="reference external" href="https://zfsonfreebsd.github.io/ZoF/">FreeBSD</a></li>
<li class="toctree-l2"><a class="reference external" href="https://wiki.gentoo.org/wiki/ZFS">Gentoo</a></li>
<li class="toctree-l2"><a class="reference external" href="https://software.opensuse.org/package/zfs">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../RHEL and CentOS.html">RHEL and CentOS</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Ubuntu</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Project and Community/index.html">Project and Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Developer Resources/index.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Performance and tuning/index.html">Performance and tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Basics concepts/index.html">Basic concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../License.html">License</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Getting Started</a><ul>
  <li><a href="index.html">Ubuntu</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Ubuntu</a></li>
      <li>Next: <a href="Ubuntu 18.04 Root on ZFS.html" title="next chapter">Ubuntu 18.04 Root on ZFS</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, OpenZFS.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/Getting Started/Ubuntu/Ubuntu 16.04 Root on ZFS.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>